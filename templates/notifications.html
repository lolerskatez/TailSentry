{% extends "base.html" %}
{% block title %}Notification Settings - TailSentry{% endblock %}
{% block head %}
    <style>
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
{% endblock %}
{% block content %}
<!-- Settings Subnavigation -->
<nav class="flex flex-wrap gap-2 sm:gap-4 mb-8 max-w-6xl mx-auto py-4 px-4" aria-label="Settings Subnavigation">
    <a href="/settings/tailsentry" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">TailSentry Config</a>
    <a href="/settings/tailscale" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">Tailscale Settings</a>
    <a href="/settings/users" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">Manage Users</a>
    <a href="/settings/appearance" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">Appearance</a>
    <a href="/settings/notifications" class="px-3 py-1 rounded font-semibold bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-current="page">Notifications</a>
    <a href="/logs" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-gray-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">Logs</a>
</nav>

<div class="max-w-6xl mx-auto py-4 px-4" x-data="notificationSettings()">

    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Notification Settings</h1>
                    <p class="mt-2 text-gray-600 dark:text-gray-400">Configure SMTP and Discord notifications</p>
                </div>
                <div class="flex space-x-2">
                    <button @click="testNotification()" 
                            :disabled="loading"
                            class="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg transition-colors">
                        <span x-show="!loading">üß™ Test Notifications</span>
                        <span x-show="loading">Testing...</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast notification container -->
        <div x-show="alert.show" 
             x-transition:enter="transition ease-out duration-300 transform"
             x-transition:enter-start="opacity-0 translate-y-2 translate-x-2"
             x-transition:enter-end="opacity-100 translate-y-0 translate-x-0"
             x-transition:leave="transition ease-in duration-200 transform"
             x-transition:leave-start="opacity-100 translate-y-0 translate-x-0"
             x-transition:leave-end="opacity-0 translate-y-2 translate-x-2"
             class="fixed top-6 right-6 z-50 max-w-md">
            <div :class="{
                'bg-green-600': alert.type === 'success',
                'bg-red-600': alert.type === 'error', 
                'bg-blue-600': alert.type === 'info',
                'bg-yellow-600': alert.type === 'warning'
            }" 
                 class="text-white px-6 py-4 rounded-lg shadow-lg flex items-start gap-3 w-full">
                <!-- Success Icon -->
                <svg x-show="alert.type === 'success'" class="h-5 w-5 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
                <!-- Error Icon -->
                <svg x-show="alert.type === 'error'" class="h-5 w-5 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
                <!-- Info Icon -->
                <svg x-show="alert.type === 'info'" class="h-5 w-5 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <!-- Warning Icon -->
                <svg x-show="alert.type === 'warning'" class="h-5 w-5 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.732 15.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
                <span x-text="alert.message" class="flex-1 text-sm leading-relaxed pr-2"></span>
                <button @click="alert.show = false" class="text-white hover:text-gray-200 flex-shrink-0 mt-0.5">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Global Settings Card -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md mb-6">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Global Settings</h2>
                <p class="text-gray-600 dark:text-gray-400 mt-1">Master controls for the notification system</p>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" x-model="settings.global_enabled" class="rounded">
                            <span class="ml-2 text-gray-700 dark:text-gray-300">Enable Notifications</span>
                        </label>
                        <p class="text-sm text-gray-500 mt-1">Master switch for all notifications</p>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" x-model="settings.rate_limit_enabled" class="rounded">
                            <span class="ml-2 text-gray-700 dark:text-gray-300">Enable Rate Limiting</span>
                        </label>
                        <p class="text-sm text-gray-500 mt-1">Prevent notification spam</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Retry Attempts</label>
                        <input type="number" x-model="settings.retry_attempts" min="1" max="10"
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        <p class="text-sm text-gray-500 mt-1">Failed delivery retry attempts</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Rate Limit (per hour)</label>
                        <input type="number" x-model="settings.rate_limit_per_hour" min="1" max="1000"
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        <p class="text-sm text-gray-500 mt-1">Maximum notifications per hour</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Channels Tabs -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
            <div class="border-b border-gray-200 dark:border-gray-700">
                <nav class="-mb-px flex space-x-8 px-6">
                    <button @click="activeTab = 'smtp'" 
                            :class="activeTab === 'smtp' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        üìß SMTP Email
                    </button>
                    <button @click="activeTab = 'discord'" 
                            :class="activeTab === 'discord' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        üí¨ Discord
                    </button>
                    <button @click="activeTab = 'templates'" 
                            :class="activeTab === 'templates' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        üìù Templates
                    </button>
                </nav>
            </div>

            <!-- SMTP Settings Tab -->
            <div x-show="activeTab === 'smtp'" class="p-6">
                <div class="mb-6">
                    <label class="flex items-center">
                        <input type="checkbox" x-model="settings.smtp.enabled" class="rounded">
                        <span class="ml-2 text-lg font-medium text-gray-900 dark:text-white">Enable SMTP Email Notifications</span>
                    </label>
                </div>
                
                <div x-show="settings.smtp.enabled" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">SMTP Server</label>
                            <input type="text" x-model="settings.smtp.smtp_server" placeholder="smtp.gmail.com"
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Port</label>
                            <select x-model="settings.smtp.smtp_port" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                <option value="25">25 (Standard)</option>
                                <option value="465">465 (SSL)</option>
                                <option value="587">587 (TLS)</option>
                                <option value="993">993 (IMAP SSL)</option>
                                <option value="995">995 (POP3 SSL)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Username</label>
                            <input type="text" x-model="settings.smtp.username" placeholder="your-email@domain.com"
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Password</label>
                            <input type="password" x-model="smtpPassword" placeholder="Enter password"
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            <p class="text-sm text-gray-500 mt-1" x-show="settings.smtp.has_password">Password is currently set</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">From Email</label>
                            <input type="email" x-model="settings.smtp.from_email" placeholder="noreply@yourdomain.com"
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">From Name</label>
                            <input type="text" x-model="settings.smtp.from_name" placeholder="TailSentry"
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                    </div>
                    
                    <div class="flex space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" x-model="settings.smtp.use_tls" class="rounded">
                            <span class="ml-2 text-gray-700 dark:text-gray-300">Use TLS</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" x-model="settings.smtp.use_ssl" class="rounded">
                            <span class="ml-2 text-gray-700 dark:text-gray-300">Use SSL</span>
                        </label>
                    </div>
                    
                    <button @click="testChannel('smtp')" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        Test SMTP Connection
                    </button>
                </div>
            </div>

            <!-- Discord Settings Tab -->
            <div x-show="activeTab === 'discord'" class="p-6">
                <div class="mb-6">
                    <label class="flex items-center">
                        <input type="checkbox" x-model="settings.discord.enabled" class="rounded">
                        <span class="ml-2 text-lg font-medium text-gray-900 dark:text-white">Enable Discord Notifications</span>
                    </label>
                </div>
                
                <div x-show="settings.discord.enabled" class="space-y-6">
                    <div class="bg-purple-50 dark:bg-purple-900/30 border border-purple-200 dark:border-purple-700 rounded-lg p-4">
                        <h4 class="font-medium text-purple-900 dark:text-purple-300">Setup Instructions:</h4>
                        <ol class="mt-2 text-sm text-purple-800 dark:text-purple-400 list-decimal list-inside space-y-1">
                            <li>Go to your Discord server settings</li>
                            <li>Navigate to Integrations ‚Üí Webhooks</li>
                            <li>Click "New Webhook" or "Create Webhook"</li>
                            <li>Set a name and select a channel</li>
                            <li>Copy the webhook URL</li>
                        </ol>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Webhook URL</label>
                            <input type="password" x-model="discordWebhookUrl" placeholder="https://discord.com/api/webhooks/..."
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            <p class="text-sm text-gray-500 mt-1" x-show="settings.discord.has_webhook_url">Webhook URL is currently set</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Username</label>
                            <input type="text" x-model="settings.discord.username" placeholder="TailSentry"
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Avatar URL (Optional)</label>
                            <input type="url" x-model="settings.discord.avatar_url" placeholder="https://example.com/avatar.png"
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Embed Color</label>
                            <div class="flex items-center space-x-2">
                                <input type="color" x-model="discordColorHex" class="h-10 w-16 rounded border">
                                <input type="text" x-model="discordColorHex" placeholder="#3498db"
                                       class="flex-1 border-gray-300 rounded-md shadow-sm">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Discord Bot Configuration -->
                    <div class="border-t border-gray-200 dark:border-gray-600 pt-6 mt-6">
                        <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">ü§ñ Discord Bot Configuration</h4>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">Configure the Discord bot for interactive commands and log retrieval</p>
                        
                        <div class="mb-4">
                            <label class="flex items-center">
                                <input type="checkbox" x-model="settings.discord_bot.enabled" class="rounded">
                                <span class="ml-2 text-gray-700 dark:text-gray-300">Enable Discord Bot</span>
                            </label>
                            <p class="text-sm text-gray-500 mt-1">Allow users to interact with TailSentry via Discord commands</p>
                        </div>
                        
                        <div x-show="settings.discord_bot.enabled" class="space-y-4">
                            <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 rounded-lg p-4">
                                <h5 class="font-medium text-blue-900 dark:text-blue-300">Bot Setup Instructions:</h5>
                                <ol class="mt-2 text-sm text-blue-800 dark:text-blue-400 list-decimal list-inside space-y-1">
                                    <li>Go to <a href="https://discord.com/developers/applications" target="_blank" class="underline">Discord Developer Portal</a></li>
                                    <li>Create a new application or select existing one</li>
                                    <li>Go to "Bot" section and create a bot</li>
                                    <li>Copy the bot token from the "Token" field</li>
                                    <li>Invite the bot to your server with proper permissions</li>
                                </ol>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Bot Token</label>
                                    <input type="password" x-model="discordBotToken" placeholder="Bot token from Discord Developer Portal"
                                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                    <p class="text-sm text-gray-500 mt-1">Keep this token secure and never share it</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Command Prefix</label>
                                    <input type="text" x-model="settings.discord_bot.command_prefix" placeholder="!"
                                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                    <p class="text-sm text-gray-500 mt-1">Prefix for bot commands (e.g., !logs)</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Log Channel ID (Optional)</label>
                                    <input type="text" x-model="settings.discord_bot.log_channel_id" placeholder="123456789012345678"
                                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                    <p class="text-sm text-gray-500 mt-1">Channel ID for log notifications</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Status Channel ID (Optional)</label>
                                    <input type="text" x-model="settings.discord_bot.status_channel_id" placeholder="123456789012345678"
                                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                    <p class="text-sm text-gray-500 mt-1">Channel ID for status updates</p>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Allowed Users (Optional)</label>
                                <textarea x-model="discordAllowedUsersText" 
                                          placeholder="user1#1234&#10;user2#5678&#10;123456789012345678"
                                          rows="3"
                                          class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></textarea>
                                <p class="text-sm text-gray-500 mt-1">Discord usernames or user IDs (one per line). Leave empty to allow all users.</p>
                            </div>
                        </div>
                    </div>
                    
                    <button @click="testChannel('discord')" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        Test Discord Webhook
                    </button>
                </div>
            </div>

            <!-- Templates Tab -->
            <div x-show="activeTab === 'templates'" class="p-6">
                <div class="mb-6">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">Notification Templates</h3>
                    <p class="text-gray-600 dark:text-gray-400">Customize notification messages for different events</p>
                </div>
                
                <div class="space-y-4">
                    <template x-for="(template, eventType) in templates" :key="eventType">
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-medium text-gray-900 dark:text-white" x-text="formatEventType(eventType)"></h4>
                                <label class="flex items-center">
                                    <input type="checkbox" x-model="template.enabled" class="rounded">
                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Enabled</span>
                                </label>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Title</label>
                                    <input type="text" x-model="template.title" 
                                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Message</label>
                                    <textarea x-model="template.message" rows="2"
                                              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm text-sm"></textarea>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
                
                <button @click="saveTemplates()" 
                        class="mt-6 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                    Save Templates
                </button>
            </div>
        </div>

        <!-- Save Button -->
        <div class="mt-8 flex justify-center">
            <button @click="saveSettings()" 
                    :disabled="loading"
                    class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-8 py-3 rounded-lg text-lg font-medium transition-colors">
                <span x-show="!loading">üíæ Save Notification Settings</span>
                <span x-show="loading">Saving...</span>
            </button>
        </div>
    </div>

    <script>
        function notificationSettings() {
            return {
                loading: false,
                activeTab: 'smtp',
                alert: {
                    show: false,
                    type: 'success',
                    message: ''
                },
                toast: {
                    show: false,
                    type: 'success',
                    message: ''
                },
                settings: {
                    global_enabled: true,
                    retry_attempts: 3,
                    retry_delay: 60,
                    rate_limit_enabled: true,
                    rate_limit_per_hour: 100,
                    smtp: {
                        enabled: false,
                        smtp_server: '',
                        smtp_port: 587,
                        use_tls: true,
                        use_ssl: false,
                        username: '',
                        from_email: 'noreply@tailsentry.local',
                        from_name: 'TailSentry',
                        has_password: false
                    },
                    discord: {
                        enabled: false,
                        username: 'TailSentry',
                        embed_color: 3447003,
                        avatar_url: '',
                        has_webhook_url: false
                    },
                    discord_bot: {
                        enabled: false,
                        command_prefix: '!',
                        log_channel_id: '',
                        status_channel_id: '',
                        allowed_users: []
                    }
                },
                templates: {},
                smtpPassword: '',
                discordWebhookUrl: '',
                discordBotToken: '',
                discordAllowedUsersText: '',
                
                get discordColorHex() {
                    return '#' + this.settings.discord.embed_color.toString(16).padStart(6, '0');
                },
                
                set discordColorHex(value) {
                    this.settings.discord.embed_color = parseInt(value.replace('#', ''), 16);
                },
                
                get discordAllowedUsersText() {
                    return this.settings.discord_bot.allowed_users.join('\n');
                },
                
                set discordAllowedUsersText(value) {
                    this.settings.discord_bot.allowed_users = value.split('\n').map(u => u.trim()).filter(u => u.length > 0);
                },
                
                init() {
                    this.loadSettings();
                    this.loadTemplates();
                },
                
                async loadSettings() {
                    try {
                        const response = await fetch('/api/notification-settings');
                        const data = await response.json();
                        this.settings = data;
                    } catch (error) {
                        this.showAlert('error', 'Failed to load notification settings');
                    }
                },
                
                async loadTemplates() {
                    try {
                        const response = await fetch('/api/notification-templates');
                        const data = await response.json();
                        this.templates = data.templates;
                    } catch (error) {
                        this.showAlert('error', 'Failed to load notification templates');
                    }
                },
                
                async saveSettings() {
                    this.loading = true;
                    try {
                        // Prepare settings with sensitive data
                        const settingsToSave = JSON.parse(JSON.stringify(this.settings));
                        
                        // Add sensitive fields if provided
                        if (this.smtpPassword) {
                            settingsToSave.smtp.password = this.smtpPassword;
                        }
                        if (this.discordWebhookUrl) {
                            settingsToSave.discord.webhook_url = this.discordWebhookUrl;
                        }
                        if (this.discordBotToken) {
                            settingsToSave.discord_bot.bot_token = this.discordBotToken;
                        }
                        
                        const response = await fetch('/api/notification-settings', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(settingsToSave)
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            this.showAlert('success', 'Notification settings saved successfully');
                            // Clear sensitive input fields
                            this.smtpPassword = '';
                            this.discordWebhookUrl = '';
                            this.discordBotToken = '';
                            // Reload to get updated has_* flags
                            this.loadSettings();
                        } else {
                            this.showAlert('error', result.detail || 'Failed to save settings');
                        }
                    } catch (error) {
                        this.showAlert('error', 'Failed to save notification settings');
                    }
                    this.loading = false;
                },
                
                async saveTemplates() {
                    try {
                        const response = await fetch('/api/notification-templates', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({templates: this.templates})
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            this.showAlert('success', 'Templates saved successfully');
                        } else {
                            this.showAlert('error', result.detail || 'Failed to save templates');
                        }
                    } catch (error) {
                        this.showAlert('error', 'Failed to save templates');
                    }
                },
                
                async testNotification() {
                    this.loading = true;
                    try {
                        this.showAlert('info', 'Sending test notifications for all types... This may take a moment.');
                        
                        const response = await fetch('/api/test-all-notifications', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'}
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            const summary = result.summary;
                            if (summary.successful === summary.total) {
                                this.showAlert('success', 
                                    `üéâ All ${summary.total} test notifications sent successfully! Check your configured channels.`);
                            } else if (summary.successful > 0) {
                                this.showAlert('warning', 
                                    `‚ö†Ô∏è ${summary.successful}/${summary.total} test notifications sent (${summary.success_rate.toFixed(1)}% success rate). Some channels may not be configured.`);
                            } else {
                                this.showAlert('error', 
                                    `‚ùå No test notifications were sent successfully. Please check your notification settings.`);
                            }
                        } else {
                            this.showAlert('error', result.detail || 'Failed to send test notifications');
                        }
                    } catch (error) {
                        this.showAlert('error', 'Failed to send test notifications');
                    }
                    this.loading = false;
                },
                
                async testChannel(channel) {
                    try {
                        const response = await fetch('/api/test-notification', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({channel: channel})
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            this.showAlert('success', `Test ${channel} notification sent!`);
                        } else {
                            this.showAlert('error', result.detail || `Failed to send ${channel} test`);
                        }
                    } catch (error) {
                        this.showAlert('error', `Failed to test ${channel} notification`);
                    }
                },
                
                formatEventType(eventType) {
                    return eventType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                },
                
                showAlert(type, message) {
                    this.alert = { show: true, type, message };
                    
                    // Different auto-dismiss times based on alert type
                    let dismissTime;
                    switch(type) {
                        case 'info':
                            dismissTime = 3000; // 3 seconds for info
                            break;
                        case 'success':
                            dismissTime = 4000; // 4 seconds for success
                            break;
                        case 'warning':
                            dismissTime = 6000; // 6 seconds for warnings
                            break;
                        case 'error':
                            dismissTime = 8000; // 8 seconds for errors
                            break;
                        default:
                            dismissTime = 4000; // Default 4 seconds
                    }
                    
                    // Auto-dismiss
                    setTimeout(() => {
                        if (this.alert.show) {
                            this.alert.show = false;
                        }
                    }, dismissTime);
                }
            }
        }
    </script>

    <!-- Toast Notifications -->
    <div x-show="toast.show" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-2 scale-95"
         x-transition:enter-end="opacity-100 transform translate-y-0 scale-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 transform translate-y-0 scale-100"
         x-transition:leave-end="opacity-0 transform translate-y-2 scale-95"
         class="fixed bottom-4 right-4 z-50">
      
      <div class="min-w-80 max-w-md w-full shadow-2xl rounded-lg pointer-events-auto ring-1 border-2"
           :class="{
             'bg-green-50 border-green-200 ring-green-500/20 dark:bg-green-900/20 dark:border-green-700': toast.type === 'success',
             'bg-red-50 border-red-200 ring-red-500/20 dark:bg-red-900/20 dark:border-red-700': toast.type === 'error',
             'bg-blue-50 border-blue-200 ring-blue-500/20 dark:bg-blue-900/20 dark:border-blue-700': toast.type === 'info'
           }">
        <div class="p-4">
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <svg x-show="toast.type === 'success'" class="h-5 w-5 text-green-600 dark:text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              <svg x-show="toast.type === 'error'" class="h-5 w-5 text-red-600 dark:text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
              <svg x-show="toast.type === 'info'" class="h-5 w-5 text-blue-600 dark:text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <div class="ml-3 w-0 flex-1 pt-0.5">
              <p class="text-sm font-medium"
                 :class="{
                   'text-green-800 dark:text-green-200': toast.type === 'success',
                   'text-red-800 dark:text-red-200': toast.type === 'error',
                   'text-blue-800 dark:text-blue-200': toast.type === 'info'
                 }"
                 x-text="toast.message"></p>
            </div>
            <div class="ml-4 flex-shrink-0 flex">
              <button @click="toast.show = false" class="inline-flex rounded-md p-1.5 focus:outline-none focus:ring-2 focus:ring-offset-2"
                      :class="{
                        'text-green-600 hover:bg-green-100 focus:ring-green-500 dark:text-green-300 dark:hover:bg-green-800': toast.type === 'success',
                        'text-red-600 hover:bg-red-100 focus:ring-red-500 dark:text-red-300 dark:hover:bg-red-800': toast.type === 'error',
                        'text-blue-600 hover:bg-blue-100 focus:ring-blue-500 dark:text-blue-300 dark:hover:bg-blue-800': toast.type === 'info'
                      }">
                <span class="sr-only">Dismiss</span>
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

</div>
{% endblock %}
