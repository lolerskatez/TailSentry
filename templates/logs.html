{% extends "base.html" %}
{% block title %}TailSentry - Logs & Diagnostics{% endblock %}
{% block content %}
<!-- Settings Subnavigation -->
<nav class="flex flex-wrap gap-2 sm:gap-4 mb-8 max-w-6xl mx-auto py-4 px-4" aria-label="Settings Subnavigation">
  <a href="/settings/tailsentry" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">General</a>
  <a href="/settings/users" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">Manage Users</a>
  <a href="/settings/appearance" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">Appearance</a>
  <a href="/settings/tailscale" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">Tailscale Settings</a>
  <a href="/settings/tailsentry" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">TailSentry Config</a>
  <a href="/settings/notifications" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">Notifications</a>
  <a href="/logs" class="px-3 py-1 rounded font-semibold bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-current="page">Logs</a>
</nav>

<div class="max-w-6xl mx-auto py-4 px-4">
  <div class="mb-8 p-6 rounded-xl shadow bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
    <div class="font-semibold text-2xl mb-2 text-indigo-700">Logs & Diagnostics</div>
    <div class="text-sm text-gray-600 dark:text-gray-300 mb-4">Access logs and diagnostic information for troubleshooting.</div>
    <form id="logs-controls" class="flex flex-wrap gap-4 mb-4 items-end">
      <div>
        <label class="block mb-1 font-medium" for="log-lines">Lines to show</label>
        <input id="log-lines" type="number" min="10" max="1000" value="100" class="w-32 px-2 py-1 rounded border border-gray-300 dark:bg-gray-700 dark:text-gray-100">
      </div>
      <div>
        <label class="block mb-1 font-medium" for="log-level">Level</label>
        <select id="log-level" class="w-32 px-2 py-1 rounded border border-gray-300 dark:bg-gray-700 dark:text-gray-100">
          <option value="">All</option>
          <option value="INFO">INFO</option>
          <option value="WARNING">WARNING</option>
          <option value="ERROR">ERROR</option>
          <option value="CRITICAL">CRITICAL</option>
        </select>
      </div>
      <div>
        <label class="block mb-1 font-medium" for="log-search">Search</label>
        <input id="log-search" type="text" placeholder="Search logs..." class="w-48 px-2 py-1 rounded border border-gray-300 dark:bg-gray-700 dark:text-gray-100">
      </div>
      <div class="flex gap-2">
        <button id="refresh-logs" type="button" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">Refresh</button>
        <button id="download-logs" type="button" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600">Download</button>
        <button id="download-logs-zip" type="button" class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Download Zip</button>
        <button id="download-diagnostics" type="button" class="px-3 py-1 bg-indigo-500 text-white rounded hover:bg-indigo-600">Download Diagnostics</button>
      </div>
      <div class="flex items-center gap-2 ml-auto">
        <input id="auto-refresh" type="checkbox" class="h-5 w-5">
        <label for="auto-refresh" class="text-sm">Auto-refresh</label>
        <input id="live-stream" type="checkbox" class="h-5 w-5 ml-4">
        <label for="live-stream" class="text-sm">Live stream</label>
      </div>
    </form>
    <pre id="logs-output" class="bg-gray-100 dark:bg-gray-900 rounded p-4 text-xs font-mono overflow-x-auto h-96 whitespace-pre-wrap"><span id="logs-output-inner">Loading logs...</span></pre>
    <div class="text-xs text-gray-500 dark:text-gray-400 mt-2">To download the full log file or a zipped archive, use the buttons above. Zipped download includes the entire current log file.</div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
// ...existing code for logs page JS...
let autoRefreshInterval = null;
function colorizeLogs(raw) {
  if (!raw) return 'No logs found.';
  return raw.split('\n').map(line => {
    if (line.includes('- ERROR -')) return `<span style="color:#dc2626;font-weight:bold;">${line}</span>`;
    if (line.includes('- WARNING -')) return `<span style="color:#f59e42;">${line}</span>`;
    if (line.includes('- CRITICAL -')) return `<span style="color:#b91c1c;font-weight:bold;background:#fee2e2;">${line}</span>`;
    if (line.includes('- INFO -')) return `<span style="color:#2563eb;">${line}</span>`;
    return line;
  }).join('\n');
}
async function loadLogs() {
  const lines = document.getElementById('log-lines').value || 100;
  const level = document.getElementById('log-level').value;
  const search = document.getElementById('log-search').value;
  const params = new URLSearchParams({ lines, level, search });
  const res = await fetch(`/api/logs?${params.toString()}`);
  const data = await res.json();
  document.getElementById('logs-output-inner').innerHTML = colorizeLogs(data.logs);
}
document.getElementById('refresh-logs').onclick = loadLogs;
document.getElementById('log-level').onchange = loadLogs;
document.getElementById('log-search').oninput = loadLogs;
document.getElementById('log-lines').onchange = loadLogs;
document.getElementById('download-logs').onclick = async function() {
  const lines = document.getElementById('log-lines').value || 100;
  const level = document.getElementById('log-level').value;
  const search = document.getElementById('log-search').value;
  const params = new URLSearchParams({ lines, level, search });
  const res = await fetch(`/api/logs?${params.toString()}`);
  const data = await res.json();
  const logs = data.logs || '';
  const blob = new Blob([logs], {type: 'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'tailsentry.log';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
};
document.getElementById('download-logs-zip').onclick = async function() {
  window.location.href = '/api/logs/download?zip=true';
};
document.getElementById('download-diagnostics').onclick = async function() {
  window.location.href = '/api/diagnostics/download';
};
let ws = null;
document.getElementById('auto-refresh').onchange = function() {
  if (this.checked) {
    loadLogs();
    autoRefreshInterval = setInterval(loadLogs, 5000);
  } else {
    clearInterval(autoRefreshInterval);
  }
};
document.getElementById('live-stream').onchange = function() {
  if (this.checked) {
    document.getElementById('auto-refresh').checked = false;
    clearInterval(autoRefreshInterval);
    document.getElementById('logs-output-inner').innerHTML = '';
    ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/logs');
    ws.onmessage = function(event) {
      const inner = document.getElementById('logs-output-inner');
      inner.innerHTML += colorizeLogs(event.data);
      inner.parentElement.scrollTop = inner.parentElement.scrollHeight;
    };
    ws.onclose = function() {
      ws = null;
    };
  } else {
    if (ws) { ws.close(); ws = null; }
    loadLogs();
  }
};
window.onload = loadLogs;
</script>
{% endblock %}
