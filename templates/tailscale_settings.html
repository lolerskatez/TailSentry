{% extends "base.html" %}
{% block title %}Tailscale Settings - TailSentry{% endblock %}

{% block content %}
<!-- Settings Subnavigation -->
<nav class="flex flex-wrap gap-2 sm:gap-4 mb-8 max-w-6xl mx-auto py-4 px-4" aria-label="Settings Subnavigation">
  <a href="/settings/tailsentry" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">TailSentry Config</a>
  <a href="/settings/tailscale" class="px-3 py-1 rounded font-semibold bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-current="page">Tailscale Settings</a>
  <a href="/settings/users" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">Manage Users</a>
  <a href="/settings/appearance" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">Appearance</a>
  <a href="/settings/notifications" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">Notifications</a>
  <a href="/logs" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-gray-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">Logs</a>
</nav>

<div class="max-w-7xl mx-auto py-4 px-4" x-data="tailscaleSettings()">
    
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-indigo-800 dark:text-indigo-200">Tailscale Management</h1>
        <div class="flex gap-2">
            <button @click="refreshStatus()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium focus:outline-none focus:ring-2 focus:ring-blue-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Refresh Status
            </button>
        </div>
    </div>

    <!-- Status Overview -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-200">Connection Status</h3>
            <div class="flex items-center">
                <div :class="(status?.BackendState === 'Running') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" class="px-3 py-1 rounded-full text-sm font-medium">
                    <span x-text="(status?.BackendState === 'Running') ? 'Online' : 'Offline'"></span>
                </div>
            </div>
            <div class="mt-3">
                <p class="text-sm text-gray-600 dark:text-gray-400">IP: <span x-text="status?.TailscaleIPs?.[0] || 'N/A'" class="font-mono"></span></p>
                <p class="text-sm text-gray-600 dark:text-gray-400">Hostname: <span x-text="status?.Self?.HostName || 'N/A'"></span></p>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-200">Network Info</h3>
            <div class="space-y-2">
                <p class="text-sm text-gray-600 dark:text-gray-400">Exit Node Status: <span x-text="activeExitNode || 'Not Advertised'" class="font-medium"></span></p>
                <p class="text-sm text-gray-600 dark:text-gray-400">Advertised Routes: <span x-text="advertisedRoutes.length || '0'"></span></p>
                <p class="text-sm text-gray-600 dark:text-gray-400">Peers: <span x-text="Object.keys(status?.Peer || {}).length || '0'"></span></p>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-200">Service Control</h3>
            <div class="grid grid-cols-2 gap-2">
                <button @click="serviceAction('up')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm font-medium">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h1m4 0h1m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Start
                </button>
                <button @click="serviceAction('down')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm font-medium">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364l12.728-12.728" />
                    </svg>
                    Stop
                </button>
                <button @click="serviceAction('restart')" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded text-sm font-medium col-span-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Restart Connection
                </button>
            </div>
        </div>
    </div>

    <!-- Tabbed Interface -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
        <div class="border-b border-gray-200 dark:border-gray-700">
            <nav class="flex space-x-8 px-6" aria-label="Tabs">
                <button @click="activeTab = 'basic'" :class="activeTab === 'basic' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Basic Settings
                </button>
                <button @click="activeTab = 'routes'" :class="activeTab === 'routes' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Subnet Routes
                </button>
                <button @click="activeTab = 'exit-node'" :class="activeTab === 'exit-node' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Exit Node
                </button>
                <button @click="activeTab = 'advanced'" :class="activeTab === 'advanced' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Advanced
                </button>
            </nav>
        </div>

        <div class="p-6">
            <!-- Basic Settings Tab -->
            <div x-show="activeTab === 'basic'" class="space-y-6">
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-medium text-gray-800 dark:text-gray-200">Auth Key (Device Registration)</h4>
                        <div x-show="hasAuthKey" class="flex items-center text-green-600 dark:text-green-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span class="text-sm font-medium">Configured</span>
                        </div>
                    </div>
                    <form @submit.prevent="saveAuthKey">
                        <div class="flex gap-2">
                            <input type="password" x-model="authKey" placeholder="Enter Tailscale Auth Key (tskey-auth-...)" 
                                   class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-800 dark:text-white">
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md font-medium">
                                Save
                            </button>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                            Used for device authentication and registration. Required for initial setup and re-authentication.
                        </p>
                    </form>
                </div>

                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-medium text-gray-800 dark:text-gray-200">Tailscale API Key (Optional)</h4>
                        <div x-show="hasApiToken" class="flex items-center text-green-600 dark:text-green-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span class="text-sm font-medium">Configured</span>
                        </div>
                    </div>
                    <form @submit.prevent="saveApiToken">
                        <div class="flex gap-2">
                            <input type="password" x-model="apiAccessToken" placeholder="Enter Tailscale API Key (tskey-api-...)" 
                                   class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-800 dark:text-white">
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md font-medium">
                                Save
                            </button>
                        </div>
                        <div class="flex items-center mt-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-500 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                            </svg>
                            <p class="text-sm text-yellow-600 dark:text-yellow-400">
                                <strong>Secure Mode:</strong> TailSentry can operate without API tokens for enhanced security. Only required for advanced network management features.
                            </p>
                        </div>
                    </form>
                </div>

                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-medium text-gray-800 dark:text-gray-200">Device Hostname</h4>
                    </div>
                    <form @submit.prevent="saveHostname">
                        <div class="flex gap-2">
                            <input type="text" x-model="hostname" :placeholder="status?.Self?.HostName || 'Enter hostname...'" 
                                   class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-800 dark:text-white">
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md font-medium">
                                Save
                            </button>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                            Set a custom hostname for this device in the Tailnet. Current: <span x-text="status?.Self?.HostName || 'Unknown'" class="font-mono"></span>
                        </p>
                    </form>
                </div>

                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                    <h4 class="text-lg font-medium mb-4 text-gray-800 dark:text-gray-200">Device Authentication</h4>
                    <div class="space-y-4">
                        <button @click="generateAuthKey" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                            </svg>
                            Generate Auth Key
                        </button>
                        
                        <div x-show="authKey" class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Generated Auth Key (for device registration):</label>
                            <div class="flex gap-2">
                                <input type="text" x-model="authKey" readonly 
                                       class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-100 dark:bg-gray-600 dark:text-white font-mono text-sm">
                                <button @click="copyToClipboard(authKey)" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-md">
                                    Copy
                                </button>
                            </div>
                            <p class="text-sm text-red-600 dark:text-red-400 mt-2">
                                ⚠️ This key will only be shown once. Save it securely. Use this to register new devices to your tailnet.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subnet Routes Tab -->
            <div x-show="activeTab === 'routes'" class="space-y-6">
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                    <h4 class="text-lg font-medium mb-4 text-gray-800 dark:text-gray-200">Advertise Subnet Routes</h4>
                    <form @submit.prevent="updateRoutes">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Routes to Advertise:</label>
                                <input type="text" x-model="routesToAdvertise" placeholder="192.168.1.0/24,10.0.0.0/8" 
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-800 dark:text-white">
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                    Comma-separated list of CIDR ranges to advertise to your tailnet.
                                </p>
                            </div>
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md font-medium">
                                Update Routes
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                    <h4 class="text-lg font-medium mb-4 text-gray-800 dark:text-gray-200">Currently Advertised Routes</h4>
                    <div x-show="advertisedRoutes.length === 0" class="text-gray-600 dark:text-gray-400">
                        No routes currently advertised.
                    </div>
                    <div x-show="advertisedRoutes.length > 0" class="space-y-2">
                        <template x-for="route in advertisedRoutes" :key="route">
                            <div class="bg-white dark:bg-gray-600 px-3 py-2 rounded border">
                                <span x-text="route" class="font-mono text-sm"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Exit Node Tab -->
            <div x-show="activeTab === 'exit-node'" class="space-y-6">
                <!-- Exit Node Overview Card -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-800 dark:to-gray-900 rounded-lg border border-blue-200 dark:border-gray-700 p-6">
                    <div class="flex items-start space-x-4">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                                <i class="fas fa-route text-blue-600 dark:text-blue-400 text-xl"></i>
                            </div>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Exit Node Configuration</h3>
                            <p class="text-sm text-gray-700 dark:text-gray-300 mb-4">
                                Exit nodes allow devices to route their internet traffic through other devices in your tailnet. 
                                You can advertise this device as an exit node for others to use, or configure this device to use another exit node.
                            </p>
                            
                            <!-- Current Status -->
                            <div class="flex items-center space-x-6">
                                <div class="flex items-center">
                                    <span class="text-sm font-medium text-gray-600 dark:text-gray-400 mr-2">Advertising:</span>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                                          :class="{
                                              'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200': exitNodeStatus === 'active_in_use',
                                              'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200': exitNodeStatus === 'approved',
                                              'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200': exitNodeStatus === 'pending_approval',
                                              'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': exitNodeStatus === 'blocked_by_policy',
                                              'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300': !advertiseExitNode || exitNodeStatus === 'disabled'
                                          }">
                                        <i :class="{
                                            'fas fa-globe mr-1': exitNodeStatus === 'active_in_use',
                                            'fas fa-check-circle mr-1': exitNodeStatus === 'approved',
                                            'fas fa-clock mr-1': exitNodeStatus === 'pending_approval',
                                            'fas fa-exclamation-triangle mr-1': exitNodeStatus === 'blocked_by_policy',
                                            'fas fa-times-circle mr-1': !advertiseExitNode || exitNodeStatus === 'disabled'
                                        }"></i>
                                        <span x-text="{
                                            'active_in_use': 'In Use',
                                            'approved': 'Available',
                                            'pending_approval': 'Pending',
                                            'blocked_by_policy': 'Blocked',
                                            'disabled': 'Disabled'
                                        }[exitNodeStatus] || 'Disabled'"></span>
                                    </span>
                                </div>
                                <div class="flex items-center">
                                    <span class="text-sm font-medium text-gray-600 dark:text-gray-400 mr-2">Using:</span>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                                          :class="activeExitNode ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'">
                                        <i :class="activeExitNode ? 'fas fa-globe mr-1' : 'fas fa-home mr-1'"></i>
                                        <span x-text="activeExitNode ? (availableExitNodes.find(n => n.id === activeExitNode)?.name || 'Unknown') : 'Direct'"></span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Advertise as Exit Node -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                        <div class="px-6 py-4 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-broadcast-tower text-orange-500 mr-3"></i>
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Advertise as Exit Node</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Share your internet connection</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <div x-show="exitNodeLoading" class="animate-spin">
                                        <i class="fas fa-spinner text-gray-400"></i>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" x-model="advertiseExitNode" @change="toggleExitNodeAdvertisement" 
                                               :disabled="exitNodeLoading"
                                               class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="space-y-4">
                                <div class="text-sm text-gray-700 dark:text-gray-300">
                                    <p class="mb-3">When enabled, other devices in your tailnet can route their internet traffic through this device.</p>
                                    
                                    <!-- Requirements Check -->
                                    <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-3">
                                        <div class="flex items-start">
                                            <i class="fas fa-exclamation-triangle text-yellow-600 dark:text-yellow-400 mt-1 mr-2"></i>
                                            <div class="text-xs text-yellow-800 dark:text-yellow-200">
                                                <p class="font-medium mb-1">Requirements:</p>
                                                <ul class="list-disc list-inside space-y-1 text-yellow-700 dark:text-yellow-300">
                                                    <li>Stable internet connection</li>
                                                    <li>Sufficient bandwidth for other users</li>
                                                    <li>Device should remain online consistently</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Status Information -->
                                <div x-show="advertiseExitNode" x-transition class="space-y-3">
                                    <!-- Active and In Use Status -->
                                    <div x-show="exitNodeStatus === 'active_in_use'" class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-3">
                                        <div class="flex items-center">
                                            <i class="fas fa-globe text-green-600 dark:text-green-400 mr-2"></i>
                                            <span class="text-sm font-medium text-green-800 dark:text-green-200">
                                                Exit node active - peers are using it
                                            </span>
                                        </div>
                                        <p class="text-xs text-green-700 dark:text-green-300 mt-1 ml-6">
                                            This device is successfully routing internet traffic for other devices in your tailnet.
                                        </p>
                                    </div>
                                    
                                    <!-- Approved but Not Used Status -->
                                    <div x-show="exitNodeStatus === 'approved'" class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3">
                                        <div class="flex items-center">
                                            <i class="fas fa-check-circle text-blue-600 dark:text-blue-400 mr-2"></i>
                                            <span class="text-sm font-medium text-blue-800 dark:text-blue-200">
                                                Exit node approved and advertising
                                            </span>
                                        </div>
                                        <p class="text-xs text-blue-700 dark:text-blue-300 mt-1 ml-6">
                                            Available for use but no peers are currently routing through it.
                                        </p>
                                    </div>
                                    
                                    <!-- Pending Approval Status -->
                                    <div x-show="exitNodeStatus === 'pending_approval'" class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-3">
                                        <div class="flex items-start">
                                            <i class="fas fa-clock text-yellow-600 dark:text-yellow-400 mr-2 mt-0.5"></i>
                                            <div class="flex-1">
                                                <span class="text-sm font-medium text-yellow-800 dark:text-yellow-200 block">
                                                    Waiting for admin approval
                                                </span>
                                                <p class="text-xs text-yellow-700 dark:text-yellow-300 mt-1">
                                                    Your exit node request has been submitted but needs to be approved by a tailnet admin.
                                                </p>
                                                <div class="mt-2">
                                                    <a :href="adminConsoleUrl" target="_blank" 
                                                       class="inline-flex items-center text-xs text-yellow-800 dark:text-yellow-200 hover:text-yellow-900 dark:hover:text-yellow-100 font-medium">
                                                        <i class="fas fa-external-link-alt mr-1"></i>
                                                        Open Tailscale Admin Console
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Blocked by Policy Status -->
                                    <div x-show="exitNodeStatus === 'blocked_by_policy'" class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3">
                                        <div class="flex items-start">
                                            <i class="fas fa-exclamation-triangle text-red-600 dark:text-red-400 mr-2 mt-0.5"></i>
                                            <div class="flex-1">
                                                <span class="text-sm font-medium text-red-800 dark:text-red-200 block">
                                                    Blocked by ACL policy
                                                </span>
                                                <p class="text-xs text-red-700 dark:text-red-300 mt-1">
                                                    Your tailnet's Access Control List (ACL) prevents this device from advertising as an exit node.
                                                </p>
                                                <div class="mt-2">
                                                    <a :href="adminConsoleUrl" target="_blank" 
                                                       class="inline-flex items-center text-xs text-red-800 dark:text-red-200 hover:text-red-900 dark:hover:text-red-100 font-medium">
                                                        <i class="fas fa-external-link-alt mr-1"></i>
                                                        Check ACL Settings in Admin Console
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Use Exit Node -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                        <div class="px-6 py-4 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-globe text-green-500 mr-3"></i>
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Use Exit Node</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Route traffic through another device</p>
                                    </div>
                                </div>
                                <button @click="refreshExitNodes" 
                                        :disabled="exitNodeLoading"
                                        class="inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-md text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500 disabled:opacity-50 transition-colors">
                                    <i class="fas fa-sync-alt mr-1" :class="{'animate-spin': exitNodeLoading}"></i>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="space-y-4">
                                <!-- No Exit Nodes Available -->
                                <div x-show="availableExitNodes.length === 0" class="text-center py-8">
                                    <i class="fas fa-info-circle text-gray-400 text-3xl mb-3"></i>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">No exit nodes available</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-500">Ask other devices in your tailnet to advertise as exit nodes</p>
                                </div>
                                
                                <!-- Exit Node Selection -->
                                <div x-show="availableExitNodes.length > 0" class="space-y-2">
                                    <!-- Direct Connection Option -->
                                    <label class="flex items-center p-3 rounded-lg cursor-pointer transition-colors"
                                           :class="selectedExitNode === '' ? 'bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-200 dark:border-blue-800' : 'hover:bg-gray-50 dark:hover:bg-gray-700 border-2 border-transparent'"
                                           @click="setExitNodeWithConfirmation('')">
                                        <input type="radio" value="" x-model="selectedExitNode" 
                                               :disabled="exitNodeLoading"
                                               class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                        <div class="ml-3 flex-1">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center">
                                                    <i class="fas fa-home text-gray-500 mr-2"></i>
                                                    <span class="text-sm font-medium text-gray-900 dark:text-white">Direct Connection</span>
                                                    <span x-show="selectedExitNode === ''" class="ml-2 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                                                        <i class="fas fa-check mr-1"></i>Active
                                                    </span>
                                                </div>
                                            </div>
                                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Use your local internet connection</p>
                                        </div>
                                    </label>
                                    
                                    <!-- Available Exit Nodes -->
                                    <template x-for="node in availableExitNodes" :key="node.id">
                                        <label class="flex items-center p-3 rounded-lg cursor-pointer transition-colors"
                                               :class="selectedExitNode === node.id ? 'bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-200 dark:border-blue-800' : 'hover:bg-gray-50 dark:hover:bg-gray-700 border-2 border-transparent'"
                                               @click="setExitNodeWithConfirmation(node.id)">
                                            <input type="radio" :value="node.id" x-model="selectedExitNode" 
                                                   :disabled="exitNodeLoading"
                                                   class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                            <div class="ml-3 flex-1">
                                                <div class="flex items-center justify-between">
                                                    <div class="flex items-center">
                                                        <i class="fas fa-server text-blue-500 mr-2"></i>
                                                        <span class="text-sm font-medium text-gray-900 dark:text-white" x-text="node.name"></span>
                                                        <span x-show="selectedExitNode === node.id" class="ml-2 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                                                            <i class="fas fa-check mr-1"></i>Active
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="flex items-center mt-1 space-x-3">
                                                    <span class="text-xs text-gray-500 dark:text-gray-400" x-text="node.ip"></span>
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                                        <i class="fas fa-circle text-green-500 mr-1 text-[8px]"></i>
                                                        Online
                                                    </span>
                                                </div>
                                            </div>
                                        </label>
                                    </template>
                                </div>
                                
                                <!-- Current Exit Node Info -->
                                <div x-show="activeExitNode && activeExitNode !== selectedExitNode" x-transition 
                                     class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-3">
                                    <div class="flex items-center">
                                        <i class="fas fa-info-circle text-amber-600 dark:text-amber-400 mr-2"></i>
                                        <span class="text-sm text-amber-800 dark:text-amber-200">
                                            You have unsaved changes. Click a selection to apply.
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced Tab -->
            <div x-show="activeTab === 'advanced'" class="space-y-6">
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                    <h4 class="text-lg font-medium mb-4 text-gray-800 dark:text-gray-200">Advanced Configuration</h4>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" x-model="acceptRoutes" @change="toggleAcceptRoutes" 
                                       class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Accept Routes</span>
                            </label>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                Accept subnet routes advertised by other devices.
                            </p>
                        </div>

                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" x-model="acceptDns" @change="toggleAcceptDns" 
                                       class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Accept DNS</span>
                            </label>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                Use DNS settings from your tailnet.
                            </p>
                        </div>

                        <div class="border-t border-gray-200 dark:border-gray-600 pt-4">
                            <h5 class="font-medium text-gray-800 dark:text-gray-200 mb-3">Cache Management</h5>
                            <button @click="clearCache" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md font-medium">
                                Clear Tailscale Cache
                            </button>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                                Clear local Tailscale state and force reconnection.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                    <h4 class="text-lg font-medium mb-4 text-gray-800 dark:text-gray-200">Debug Information</h4>
                    <div class="space-y-2">
                        <button @click="showDebugInfo = !showDebugInfo" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md font-medium">
                            <span x-text="showDebugInfo ? 'Hide' : 'Show'"></span> Debug Info
                        </button>
                        <div x-show="showDebugInfo" class="mt-4">
                            <pre x-text="JSON.stringify(status, null, 2)" class="bg-gray-800 text-green-400 p-4 rounded text-xs overflow-auto max-h-96 font-mono"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Display -->
    <div x-show="message" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform translate-y-2" x-transition:enter-end="opacity-100 transform translate-y-0" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 transform translate-y-0" x-transition:leave-end="opacity-0 transform translate-y-2" :class="messageType === 'error' ? 'bg-red-100 border-red-400 text-red-700' : 'bg-green-100 border-green-400 text-green-700'" class="fixed bottom-4 right-4 border px-4 py-3 rounded shadow-lg">
        <span x-text="message"></span>
    </div>
</div>

<script>
function tailscaleSettings() {
    return {
        activeTab: 'basic',
        status: null,
        personalAccessToken: '', // Keep for backwards compatibility
        apiAccessToken: '',
        authKey: '',
        hostname: '',
        hasAuthKey: false,
        hasApiToken: false,
        routesToAdvertise: '',
        advertisedRoutes: [],
        availableExitNodes: [],
        selectedExitNode: '',
        activeExitNode: '',
        advertiseExitNode: false,
        exitNodeStatus: 'disabled', // 'disabled', 'pending_approval', 'approved'
        adminConsoleUrl: 'https://login.tailscale.com/admin/machines',
        exitNodeLoading: false,
        acceptRoutes: false,
        acceptDns: false,
        showDebugInfo: false,
        message: '',
        messageType: 'success',

        async init() {
            await this.loadStatus();
            await this.loadSettings();
            
            // Auto-refresh when exit node is pending approval
            this.startAutoRefresh();
        },
        
        startAutoRefresh() {
            // Refresh every 10 seconds if exit node is pending approval
            setInterval(async () => {
                if (this.exitNodeStatus === 'pending_approval') {
                    await this.loadSettings();
                    await this.loadStatus();
                }
            }, 10000);
        },

        async loadStatus() {
            try {
                const response = await fetch('/api/status');
                if (response.ok) {
                    this.status = await response.json();
                    this.updateExitNodeInfo();
                    this.updateRouteInfo();
                }
            } catch (error) {
                console.error('Error loading status:', error);
            }
        },

        async loadSettings() {
            try {
                const response = await fetch('/api/tailscale-settings');
                if (response.ok) {
                    const settings = await response.json();
                    this.acceptRoutes = settings.accept_routes || false;
                    this.acceptDns = settings.accept_dns || false;
                    this.advertiseExitNode = settings.advertise_exit_node || false;
                    this.exitNodeStatus = settings.exit_node_status || 'disabled';
                    this.adminConsoleUrl = settings.admin_console_url || 'https://login.tailscale.com/admin/machines';
                    
                    // Load status indicators
                    this.hasAuthKey = settings.has_auth_key || false;
                    this.hasApiToken = settings.has_api_key || false;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        },

        updateExitNodeInfo() {
            if (!this.status) return;
            
            this.availableExitNodes = Object.values(this.status.Peer || {})
                .filter(peer => peer.ExitNodeOption)
                .map(peer => ({
                    id: peer.ID,
                    name: peer.HostName,
                    ip: peer.TailscaleIPs[0]
                }));

            // Check if this device is advertising as an exit node
            const isAdvertisingExitNode = this.status.Self?.ExitNodeOption || false;
            this.activeExitNode = isAdvertisingExitNode ? 'Advertised' : 'Not Advertised';
            this.selectedExitNode = this.activeExitNode;
        },

        updateRouteInfo() {
            if (!this.status || !this.status.Self) return;
            
            this.advertisedRoutes = this.status.Self.PrimaryRoutes || [];
            this.routesToAdvertise = this.advertisedRoutes.join(',');
        },

        async refreshStatus() {
            await this.loadStatus();
            await this.loadSettings(); // Also refresh settings to get latest approval status
            this.showMessage('Status refreshed');
        },

        async saveApiToken() {
            try {
                const response = await fetch('/api/tailscale-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tailscale_api_token: this.apiAccessToken })
                });
                
                const result = await response.json();
                if (result.success) {
                    this.showMessage('Tailscale API Key saved successfully');
                    this.apiAccessToken = '';
                } else {
                    this.showMessage('Error saving Tailscale API Key: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            }
        },

        async saveAuthKey() {
            try {
                const response = await fetch('/api/tailscale-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tailscale_auth_key: this.authKey })
                });
                
                const result = await response.json();
                if (result.success) {
                    this.showMessage('Auth Key saved successfully');
                    this.authKey = '';
                } else {
                    this.showMessage('Error saving Auth Key: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            }
        },

        async saveHostname() {
            try {
                const response = await fetch('/api/tailscale-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hostname: this.hostname })
                });
                
                const result = await response.json();
                if (result.success) {
                    this.showMessage('Hostname saved successfully');
                    this.hostname = '';
                    // Refresh status to show the updated hostname
                    await this.loadStatus();
                } else {
                    this.showMessage('Error saving hostname: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            }
        },

        async generateAuthKey() {
            this.showMessage('Auth key generation not implemented yet', 'error');
            // Auth key generation requires Tailscale API implementation
        },

        async updateRoutes() {
            try {
                const routes = this.routesToAdvertise.split(',').map(r => r.trim()).filter(r => r);
                const response = await fetch('/api/subnet-routes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ routes })
                });
                
                const result = await response.json();
                if (result.success) {
                    this.showMessage('Routes updated successfully');
                    await this.loadStatus();
                } else {
                    this.showMessage('Error updating routes: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            }
        },

        async setExitNode() {
            this.exitNodeLoading = true;
            try {
                const response = await fetch('/api/exit-node', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ node_id: this.selectedExitNode || null })
                });
                
                const result = await response.json();
                if (result.success) {
                    this.showMessage('Exit node updated successfully');
                    await this.loadStatus();
                } else {
                    this.showMessage('Error updating exit node: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            } finally {
                this.exitNodeLoading = false;
            }
        },

        async toggleExitNodeAdvertisement() {
            this.exitNodeLoading = true;
            try {
                const response = await fetch('/api/tailscale-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ advertise_exit_node: this.advertiseExitNode })
                });
                
                const result = await response.json();
                if (result.success) {
                    this.showMessage('Exit node advertisement updated');
                    // Reload both status and settings to ensure UI reflects current state
                    await this.loadStatus();
                    await this.loadSettings();
                } else {
                    this.showMessage('Error updating exit node advertisement: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            } finally {
                this.exitNodeLoading = false;
            }
        },

        async toggleAcceptRoutes() {
            await this.updateBooleanSetting('accept_routes', this.acceptRoutes);
        },

        async toggleAcceptDns() {
            await this.updateBooleanSetting('accept_dns', this.acceptDns);
        },

        async updateBooleanSetting(setting, value) {
            try {
                const response = await fetch('/api/tailscale-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [setting]: value })
                });
                
                const result = await response.json();
                if (result.success) {
                    this.showMessage(`${setting.replace('_', ' ')} updated successfully`);
                } else {
                    this.showMessage(`Error updating ${setting}: ` + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            }
        },

        async serviceAction(action) {
            try {
                const response = await fetch('/api/tailscale-service', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });
                
                const result = await response.json();
                if (result.success) {
                    this.showMessage(`Service ${action} successful`);
                    if (action !== 'down') {
                        setTimeout(() => this.loadStatus(), 2000);
                    }
                } else {
                    this.showMessage(`Error performing ${action}: ` + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            }
        },

        async clearCache() {
            try {
                const response = await fetch('/api/clear-cache', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                if (result.success) {
                    this.showMessage('Cache cleared successfully', 'success');
                    this.loadStatus();
                } else {
                    this.showMessage('Error clearing cache: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            }
        },

        async setExitNodeWithConfirmation(nodeId) {
            if (this.exitNodeLoading) return;
            
            // Update the selection immediately for UI feedback
            this.selectedExitNode = nodeId;
            
            // Apply the change
            await this.setExitNode();
        },

        async refreshExitNodes() {
            this.exitNodeLoading = true;
            try {
                await this.loadStatus();
                this.showMessage('Exit nodes refreshed');
            } catch (error) {
                this.showMessage('Error refreshing exit nodes: ' + error.message, 'error');
            } finally {
                this.exitNodeLoading = false;
            }
        },

        async copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                this.showMessage('Copied to clipboard');
            } catch (error) {
                this.showMessage('Failed to copy to clipboard', 'error');
            }
        },

        showMessage(text, type = 'success') {
            this.message = text;
            this.messageType = type;
            setTimeout(() => {
                this.message = '';
            }, 5000);
        }
    }
}
</script>
{% endblock %}
