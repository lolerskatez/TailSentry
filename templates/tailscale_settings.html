{% extends "base.html" %}
{% block title %}Tailscale Settings - TailSentry{% endblock %}

{% block content %}
<!-- Settings Subnavigation -->
<nav class="flex flex-wrap gap-2 sm:gap-4 mb-8 max-w-6xl mx-auto py-4 px-4" aria-label="Settings Subnavigation">
  <a href="/settings/tailsentry" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">TailSentry Config</a>
  <a href="/settings/tailscale" class="px-3 py-1 rounded font-semibold bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-current="page">Tailscale Settings</a>
  <a href="/settings/users" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">Manage Users</a>
  <a href="/settings/appearance" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">Appearance</a>
  <a href="/settings/notifications" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">Notifications</a>
  <a href="/logs" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-gray-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">Logs</a>
</nav>

<div class="max-w-7xl mx-auto py-4 px-4" x-data="tailscaleSettings()">
    
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-indigo-800 dark:text-indigo-200">Tailscale Management</h1>
        <div class="flex gap-2">
            <button @click="refreshStatus()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium focus:outline-none focus:ring-2 focus:ring-blue-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Refresh Status
            </button>
        </div>
    </div>

    <!-- Status Overview -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-200">Connection Status</h3>
            <div class="flex items-center">
                <div :class="status?.online ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" class="px-3 py-1 rounded-full text-sm font-medium">
                    <span x-text="status?.online ? 'Online' : 'Offline'"></span>
                </div>
            </div>
            <div class="mt-3">
                <p class="text-sm text-gray-600 dark:text-gray-400">IP: <span x-text="status?.TailscaleIPs?.[0] || 'N/A'" class="font-mono"></span></p>
                <p class="text-sm text-gray-600 dark:text-gray-400">Hostname: <span x-text="status?.HostName || 'N/A'"></span></p>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-200">Network Info</h3>
            <div class="space-y-2">
                <p class="text-sm text-gray-600 dark:text-gray-400">Exit Node: <span x-text="activeExitNode || 'None'" class="font-medium"></span></p>
                <p class="text-sm text-gray-600 dark:text-gray-400">Advertised Routes: <span x-text="advertisedRoutes.length || '0'"></span></p>
                <p class="text-sm text-gray-600 dark:text-gray-400">Peers: <span x-text="Object.keys(status?.Peer || {}).length || '0'"></span></p>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-200">Service Control</h3>
            <div class="space-y-2">
                <button @click="serviceAction('restart')" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded font-medium">
                    Restart Service
                </button>
                <button @click="serviceAction('down')" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-medium">
                    Stop Tailscale
                </button>
            </div>
        </div>
    </div>

    <!-- Tabbed Interface -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
        <div class="border-b border-gray-200 dark:border-gray-700">
            <nav class="flex space-x-8 px-6" aria-label="Tabs">
                <button @click="activeTab = 'basic'" :class="activeTab === 'basic' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Basic Settings
                </button>
                <button @click="activeTab = 'routes'" :class="activeTab === 'routes' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Subnet Routes
                </button>
                <button @click="activeTab = 'exit-node'" :class="activeTab === 'exit-node' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Exit Node
                </button>
                <button @click="activeTab = 'advanced'" :class="activeTab === 'advanced' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Advanced
                </button>
            </nav>
        </div>

        <div class="p-6">
            <!-- Basic Settings Tab -->
            <div x-show="activeTab === 'basic'" class="space-y-6">
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                    <h4 class="text-lg font-medium mb-4 text-gray-800 dark:text-gray-200">Personal Access Token</h4>
                    <form @submit.prevent="savePatToken">
                        <div class="flex gap-2">
                            <input type="password" x-model="personalAccessToken" placeholder="Enter Tailscale API Token" 
                                   class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-800 dark:text-white">
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md font-medium">
                                Save
                            </button>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                            Required for API access to manage devices and settings.
                        </p>
                    </form>
                </div>

                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                    <h4 class="text-lg font-medium mb-4 text-gray-800 dark:text-gray-200">Machine Authentication</h4>
                    <div class="space-y-4">
                        <button @click="generateAuthKey" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                            </svg>
                            Generate Auth Key
                        </button>
                        
                        <div x-show="authKey" class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Generated Auth Key:</label>
                            <div class="flex gap-2">
                                <input type="text" x-model="authKey" readonly 
                                       class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-100 dark:bg-gray-600 dark:text-white font-mono text-sm">
                                <button @click="copyToClipboard(authKey)" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-md">
                                    Copy
                                </button>
                            </div>
                            <p class="text-sm text-red-600 dark:text-red-400 mt-2">
                                ⚠️ This key will only be shown once. Save it securely.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subnet Routes Tab -->
            <div x-show="activeTab === 'routes'" class="space-y-6">
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                    <h4 class="text-lg font-medium mb-4 text-gray-800 dark:text-gray-200">Advertise Subnet Routes</h4>
                    <form @submit.prevent="updateRoutes">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Routes to Advertise:</label>
                                <input type="text" x-model="routesToAdvertise" placeholder="192.168.1.0/24,10.0.0.0/8" 
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-800 dark:text-white">
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                    Comma-separated list of CIDR ranges to advertise to your tailnet.
                                </p>
                            </div>
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md font-medium">
                                Update Routes
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                    <h4 class="text-lg font-medium mb-4 text-gray-800 dark:text-gray-200">Currently Advertised Routes</h4>
                    <div x-show="advertisedRoutes.length === 0" class="text-gray-600 dark:text-gray-400">
                        No routes currently advertised.
                    </div>
                    <div x-show="advertisedRoutes.length > 0" class="space-y-2">
                        <template x-for="route in advertisedRoutes" :key="route">
                            <div class="bg-white dark:bg-gray-600 px-3 py-2 rounded border">
                                <span x-text="route" class="font-mono text-sm"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Exit Node Tab -->
            <div x-show="activeTab === 'exit-node'" class="space-y-6">
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                    <h4 class="text-lg font-medium mb-4 text-gray-800 dark:text-gray-200">Exit Node Configuration</h4>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" x-model="advertiseExitNode" @change="toggleExitNodeAdvertisement" 
                                       class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Advertise as Exit Node</span>
                            </label>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                Allow other devices in your tailnet to route their internet traffic through this machine.
                            </p>
                        </div>

                        <div class="border-t border-gray-200 dark:border-gray-600 pt-4">
                            <h5 class="font-medium text-gray-800 dark:text-gray-200 mb-3">Available Exit Nodes</h5>
                            <div x-show="availableExitNodes.length === 0" class="text-gray-600 dark:text-gray-400">
                                No exit nodes available.
                            </div>
                            <div x-show="availableExitNodes.length > 0" class="space-y-2">
                                <template x-for="node in availableExitNodes" :key="node.id">
                                    <label class="flex items-center p-3 bg-white dark:bg-gray-600 rounded border cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-500">
                                        <input type="radio" :value="node.id" x-model="selectedExitNode" @change="setExitNode" 
                                               class="text-indigo-600 focus:ring-indigo-500">
                                        <div class="ml-3 flex-1">
                                            <div class="font-medium text-gray-900 dark:text-gray-100" x-text="node.name"></div>
                                            <div class="text-sm text-gray-600 dark:text-gray-400" x-text="node.ip"></div>
                                        </div>
                                        <div x-show="node.id === activeExitNode" class="text-green-600 dark:text-green-400">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                            </svg>
                                        </div>
                                    </label>
                                </template>
                                <label class="flex items-center p-3 bg-white dark:bg-gray-600 rounded border cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-500">
                                    <input type="radio" value="" x-model="selectedExitNode" @change="setExitNode" 
                                           class="text-indigo-600 focus:ring-indigo-500">
                                    <div class="ml-3">
                                        <div class="font-medium text-gray-900 dark:text-gray-100">None (Direct Internet)</div>
                                        <div class="text-sm text-gray-600 dark:text-gray-400">Don't use any exit node</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced Tab -->
            <div x-show="activeTab === 'advanced'" class="space-y-6">
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                    <h4 class="text-lg font-medium mb-4 text-gray-800 dark:text-gray-200">Advanced Configuration</h4>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" x-model="acceptRoutes" @change="toggleAcceptRoutes" 
                                       class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Accept Routes</span>
                            </label>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                Accept subnet routes advertised by other devices.
                            </p>
                        </div>

                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" x-model="acceptDns" @change="toggleAcceptDns" 
                                       class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Accept DNS</span>
                            </label>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                Use DNS settings from your tailnet.
                            </p>
                        </div>

                        <div class="border-t border-gray-200 dark:border-gray-600 pt-4">
                            <h5 class="font-medium text-gray-800 dark:text-gray-200 mb-3">Cache Management</h5>
                            <button @click="clearCache" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md font-medium">
                                Clear Tailscale Cache
                            </button>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                                Clear local Tailscale state and force reconnection.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                    <h4 class="text-lg font-medium mb-4 text-gray-800 dark:text-gray-200">Debug Information</h4>
                    <div class="space-y-2">
                        <button @click="showDebugInfo = !showDebugInfo" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md font-medium">
                            <span x-text="showDebugInfo ? 'Hide' : 'Show'"></span> Debug Info
                        </button>
                        <div x-show="showDebugInfo" class="mt-4">
                            <pre x-text="JSON.stringify(status, null, 2)" class="bg-gray-800 text-green-400 p-4 rounded text-xs overflow-auto max-h-96 font-mono"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Display -->
    <div x-show="message" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform translate-y-2" x-transition:enter-end="opacity-100 transform translate-y-0" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 transform translate-y-0" x-transition:leave-end="opacity-0 transform translate-y-2" :class="messageType === 'error' ? 'bg-red-100 border-red-400 text-red-700' : 'bg-green-100 border-green-400 text-green-700'" class="fixed bottom-4 right-4 border px-4 py-3 rounded shadow-lg">
        <span x-text="message"></span>
    </div>
</div>

<script>
function tailscaleSettings() {
    return {
        activeTab: 'basic',
        status: null,
        personalAccessToken: '',
        authKey: '',
        routesToAdvertise: '',
        advertisedRoutes: [],
        availableExitNodes: [],
        selectedExitNode: '',
        activeExitNode: '',
        advertiseExitNode: false,
        acceptRoutes: false,
        acceptDns: false,
        showDebugInfo: false,
        message: '',
        messageType: 'success',

        async init() {
            await this.loadStatus();
            await this.loadSettings();
        },

        async loadStatus() {
            try {
                const response = await fetch('/api/tailscale/status');
                if (response.ok) {
                    this.status = await response.json();
                    this.updateExitNodeInfo();
                    this.updateRouteInfo();
                }
            } catch (error) {
                console.error('Error loading status:', error);
            }
        },

        async loadSettings() {
            try {
                const response = await fetch('/api/tailscale/settings');
                if (response.ok) {
                    const settings = await response.json();
                    this.acceptRoutes = settings.accept_routes || false;
                    this.acceptDns = settings.accept_dns || false;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        },

        updateExitNodeInfo() {
            if (!this.status) return;
            
            this.availableExitNodes = Object.values(this.status.Peer || {})
                .filter(peer => peer.ExitNodeOption)
                .map(peer => ({
                    id: peer.ID,
                    name: peer.HostName,
                    ip: peer.TailscaleIPs[0]
                }));

            this.activeExitNode = this.status.ExitNodeStatus?.ID || '';
            this.selectedExitNode = this.activeExitNode;
        },

        updateRouteInfo() {
            if (!this.status || !this.status.Self) return;
            
            this.advertisedRoutes = this.status.Self.PrimaryRoutes || [];
            this.routesToAdvertise = this.advertisedRoutes.join(',');
        },

        async refreshStatus() {
            await this.loadStatus();
            this.showMessage('Status refreshed');
        },

        async savePatToken() {
            try {
                const response = await fetch('/api/tailscale/pat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: this.personalAccessToken })
                });
                
                const result = await response.json();
                if (result.success) {
                    this.showMessage('PAT token saved successfully');
                    this.personalAccessToken = '';
                } else {
                    this.showMessage('Error saving PAT token: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            }
        },

        async generateAuthKey() {
            try {
                const response = await fetch('/api/tailscale/auth-key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                if (result.success) {
                    this.authKey = result.auth_key;
                    this.showMessage('Auth key generated successfully');
                } else {
                    this.showMessage('Error generating auth key: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            }
        },

        async updateRoutes() {
            try {
                const routes = this.routesToAdvertise.split(',').map(r => r.trim()).filter(r => r);
                const response = await fetch('/api/tailscale/routes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ routes })
                });
                
                const result = await response.json();
                if (result.success) {
                    this.showMessage('Routes updated successfully');
                    await this.loadStatus();
                } else {
                    this.showMessage('Error updating routes: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            }
        },

        async setExitNode() {
            try {
                const response = await fetch('/api/tailscale/exit-node', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ node_id: this.selectedExitNode || null })
                });
                
                const result = await response.json();
                if (result.success) {
                    this.showMessage('Exit node updated successfully');
                    await this.loadStatus();
                } else {
                    this.showMessage('Error updating exit node: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            }
        },

        async toggleExitNodeAdvertisement() {
            try {
                const response = await fetch('/api/tailscale/advertise-exit-node', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ advertise: this.advertiseExitNode })
                });
                
                const result = await response.json();
                if (result.success) {
                    this.showMessage('Exit node advertisement updated');
                    await this.loadStatus();
                } else {
                    this.showMessage('Error updating exit node advertisement: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            }
        },

        async toggleAcceptRoutes() {
            await this.updateBooleanSetting('accept_routes', this.acceptRoutes);
        },

        async toggleAcceptDns() {
            await this.updateBooleanSetting('accept_dns', this.acceptDns);
        },

        async updateBooleanSetting(setting, value) {
            try {
                const response = await fetch('/api/tailscale/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [setting]: value })
                });
                
                const result = await response.json();
                if (result.success) {
                    this.showMessage(`${setting.replace('_', ' ')} updated successfully`);
                } else {
                    this.showMessage(`Error updating ${setting}: ` + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            }
        },

        async serviceAction(action) {
            try {
                const response = await fetch(`/api/tailscale/service/${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                if (result.success) {
                    this.showMessage(`Service ${action} successful`);
                    if (action !== 'down') {
                        setTimeout(() => this.loadStatus(), 2000);
                    }
                } else {
                    this.showMessage(`Error performing ${action}: ` + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            }
        },

        async clearCache() {
            try {
                const response = await fetch('/api/tailscale/clear-cache', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                if (result.success) {
                    this.showMessage('Cache cleared successfully', 'success');
                    this.loadStatus();
                } else {
                    this.showMessage('Error clearing cache: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            }
        },

        async copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                this.showMessage('Copied to clipboard');
            } catch (error) {
                this.showMessage('Failed to copy to clipboard', 'error');
            }
        },

        showMessage(text, type = 'success') {
            this.message = text;
            this.messageType = type;
            setTimeout(() => {
                this.message = '';
            }, 5000);
        }
    }
}
</script>
{% endblock %}
