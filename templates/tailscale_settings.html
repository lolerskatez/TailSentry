{% extends "base.html" %}
{% block title %}Tailscale Settings - TailSentry{% endblock %}
{% block content %}
<!-- Settings Subnavigation -->
<nav class="flex flex-wrap gap-2 sm:gap-4 mb-8 max-w-6xl mx-auto py-4 px-4" aria-label="Settings Subnavigation">
    <a href="/settings" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">General</a>
    <a href="/settings/users" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">Manage Users</a>
    <a href="/settings/appearance" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">Appearance</a>
    <a href="/settings/tailscale" class="px-3 py-1 rounded font-semibold bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-current="page">Tailscale Settings</a>
    <a href="/settings/tailsentry" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">TailSentry Config</a>
    <a href="/settings/notifications" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">Notifications</a>
    <a href="/logs" class="px-3 py-1 rounded font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-gray-800 dark:hover:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">Logs</a>
</nav>

<div class="max-w-7xl mx-auto py-4 px-4" x-data="tailscaleSettings()">
    
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-indigo-800 dark:text-indigo-200">Tailscale Management</h1>
        <div class="flex gap-2">
            <button @click="refreshStatus()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium focus:outline-none focus:ring-2 focus:ring-blue-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Refresh Status
            </button>
        </div>
    </div>

    <!-- Status Overview -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-200">Connection Status</h3>
            <div class="flex items-center">
                <div :class="status?.online ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" class="px-3 py-1 rounded-full text-sm font-medium">
                    <span x-text="status?.online ? 'Online' : 'Offline'"></span>
                </div>
            </div>
            <div class="mt-3">
                <p class="text-sm text-gray-600 dark:text-gray-400">IP: <span x-text="status?.TailscaleIPs?.[0] || 'N/A'" class="font-mono"></span></p>
                <p class="text-sm text-gray-600 dark:text-gray-400">Hostname: <span x-text="status?.HostName || 'N/A'"></span></p>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-200">Network Info</h3>
            <div class="space-y-2">
                <p class="text-sm text-gray-600 dark:text-gray-400">Exit Node: <span x-text="activeExitNode || 'None'" class="font-medium"></span></p>
                <p class="text-sm text-gray-600 dark:text-gray-400">Advertised Routes: <span x-text="advertisedRoutes.length || '0'"></span></p>
                <p class="text-sm text-gray-600 dark:text-gray-400">Peers: <span x-text="Object.keys(status?.Peer || {}).length || '0'"></span></p>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold mb-3 text-gray-800 dark:text-gray-200">Service Control</h3>
            <div class="space-y-2">
                <button @click="serviceAction('restart')" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded font-medium">
                    Restart Service
                </button>
                <button @click="serviceAction('down')" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-medium">
                    Stop Tailscale
                </button>
            </div>
        </div>
    </div>

    <!-- Tabbed Interface -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
        <div class="border-b border-gray-200 dark:border-gray-700">
            <nav class="flex space-x-8 px-6" aria-label="Tabs">
                <button @click="activeTab = 'basic'" :class="activeTab === 'basic' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Basic Settings
                </button>
                <button @click="activeTab = 'routes'" :class="activeTab === 'routes' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Subnet Routes
                </button>
                <button @click="activeTab = 'exit-node'" :class="activeTab === 'exit-node' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Exit Node
                </button>
                <button @click="activeTab = 'advanced'" :class="activeTab === 'advanced' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Advanced
                </button>
            </nav>
        </div>

        <div class="p-6">
            <!-- Basic Settings Tab -->
            <div x-show="activeTab === 'basic'" class="space-y-6">
                <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200">Basic Tailscale Settings</h2>
                
                <form @submit.prevent="applyBasicSettings()" class="space-y-4">
                    <!-- Personal Access Token Section -->
                    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-medium text-blue-800 dark:text-blue-200 mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                            </svg>
                            Personal Access Token
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Tailscale PAT
                                </label>
                                <input type="password" x-model="settings.tailscale_pat" 
                                       placeholder="Enter your Tailscale Personal Access Token"
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
                                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                                    Required for API access. Get your PAT from 
                                    <a href="https://login.tailscale.com/admin/settings/keys" target="_blank" class="text-blue-600 hover:text-blue-500 underline">
                                        Tailscale Admin Console
                                    </a>
                                </p>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div x-show="settings.tailscale_pat" class="flex items-center text-green-600 dark:text-green-400">
                                        <svg class="h-4 w-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                        </svg>
                                        <span class="text-sm">PAT Configured</span>
                                    </div>
                                    <div x-show="!settings.tailscale_pat" class="flex items-center text-orange-600 dark:text-orange-400">
                                        <svg class="h-4 w-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                        </svg>
                                        <span class="text-sm">PAT Required</span>
                                    </div>
                                </div>
                                <button type="button" @click="clearPAT()" x-show="settings.tailscale_pat" 
                                        class="text-red-600 hover:text-red-800 text-sm underline">
                                    Clear PAT
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Hostname</label>
                            <input type="text" x-model="settings.hostname" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" placeholder="tailsentry-router">
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Set a custom hostname for this device</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Accept Routes</label>
                            <div class="flex items-center">
                                <input type="checkbox" x-model="settings.accept_routes" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Accept subnet routes from other devices</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            Apply Settings
                        </button>
                    </div>
                </form>
            </div>

            <!-- Subnet Routes Tab -->
            <div x-show="activeTab === 'routes'" class="space-y-6">
                <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200">Subnet Route Management</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Current Routes -->
                    <div>
                        <h3 class="text-lg font-medium mb-4 text-gray-700 dark:text-gray-300">Current Advertised Routes</h3>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <template x-if="advertisedRoutes.length > 0">
                                <div class="space-y-2">
                                    <template x-for="route in advertisedRoutes" :key="route">
                                        <div class="flex justify-between items-center py-2 px-3 bg-white dark:bg-gray-600 rounded border">
                                            <span x-text="route" class="font-mono text-sm"></span>
                                            <button @click="removeRoute(route)" class="text-red-600 hover:text-red-800">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                </svg>
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </template>
                            <template x-if="advertisedRoutes.length === 0">
                                <p class="text-gray-500 dark:text-gray-400 text-center py-4">No routes currently advertised</p>
                            </template>
                        </div>
                    </div>

                    <!-- Add Routes -->
                    <div>
                        <h3 class="text-lg font-medium mb-4 text-gray-700 dark:text-gray-300">Add New Routes</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Subnet (CIDR)</label>
                                <input type="text" x-model="newRoute" @keyup.enter="addRoute()" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" placeholder="e.g., 192.168.1.0/24">
                            </div>
                            <button @click="addRoute()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                                Add Route
                            </button>
                            
                            <!-- Auto-detected local subnets -->
                            <div class="mt-6">
                                <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Detected Local Subnets</h4>
                                <div class="space-y-2">
                                    <template x-for="subnet in detectedSubnets" :key="subnet.cidr">
                                        <div class="flex justify-between items-center py-2 px-3 bg-blue-50 dark:bg-blue-900/20 rounded border border-blue-200 dark:border-blue-800">
                                            <div>
                                                <span x-text="subnet.cidr" class="font-mono text-sm"></span>
                                                <span x-text="'(' + subnet.interface + ')'" class="text-xs text-gray-500 ml-2"></span>
                                            </div>
                                            <button @click="addDetectedRoute(subnet.cidr)" class="text-blue-600 hover:text-blue-800 text-sm">
                                                Add
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Exit Node Tab -->
            <div x-show="activeTab === 'exit-node'" class="space-y-6">
                <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200">Exit Node Configuration</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Enable as Exit Node -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6">
                        <h3 class="text-lg font-medium mb-4 text-gray-700 dark:text-gray-300">Enable as Exit Node</h3>
                        <div class="space-y-4">
                            <div class="flex items-center">
                                <input type="checkbox" x-model="settings.exit_node_enable" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Allow other devices to use this as an exit node</span>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" x-model="settings.exit_node_firewall" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Enable exit node firewall</span>
                            </div>
                            <button @click="applyExitNodeSettings()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium">
                                Apply Exit Node Settings
                            </button>
                        </div>
                    </div>

                    <!-- Use Exit Node -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6">
                        <h3 class="text-lg font-medium mb-4 text-gray-700 dark:text-gray-300">Use Exit Node</h3>
                        <div class="space-y-4">
                            <select x-model="selectedExitNode" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-gray-100">
                                <option value="">No exit node</option>
                                <template x-for="node in availableExitNodes" :key="node.id">
                                    <option :value="node.id" x-text="node.name + ' (' + node.ip + ')'"></option>
                                </template>
                            </select>
                            <button @click="setExitNode()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">
                                Set Exit Node
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced Tab -->
            <div x-show="activeTab === 'advanced'" class="space-y-6">
                <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200">Advanced Settings</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Service Management -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6">
                        <h3 class="text-lg font-medium mb-4 text-gray-700 dark:text-gray-300">Service Management</h3>
                        <div class="space-y-3">
                            <button @click="serviceAction('status')" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium">
                                Check Service Status
                            </button>
                            <button @click="serviceAction('up')" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-medium">
                                Start Tailscale
                            </button>
                            <button @click="getLogs()" class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded font-medium">
                                View Logs
                            </button>
                        </div>
                    </div>

                    <!-- Network Diagnostics -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6">
                        <h3 class="text-lg font-medium mb-4 text-gray-700 dark:text-gray-300">Network Diagnostics</h3>
                        <div class="space-y-3">
                            <button @click="getNetworkMetrics()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded font-medium">
                                Network Metrics
                            </button>
                            <button @click="clearCache()" class="w-full bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded font-medium">
                                Clear Cache
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Logs Display -->
                <div x-show="logs" class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm max-h-96 overflow-y-auto">
                    <pre x-text="logs"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Messages -->
    <div x-show="message" x-transition class="fixed bottom-4 right-4 max-w-sm">
        <div :class="messageType === 'success' ? 'bg-green-500' : 'bg-red-500'" class="text-white p-4 rounded-lg shadow-lg">
            <div class="flex justify-between items-center">
                <span x-text="message"></span>
                <button @click="message = ''" class="text-white hover:text-gray-200 ml-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>
    </div>
</div>

<script>
function tailscaleSettings() {
    return {
        activeTab: 'basic',
        status: null,
        settings: {
            hostname: 'tailsentry-router',
            accept_routes: false,
            exit_node_enable: false,
            exit_node_firewall: false,
            tailscale_pat: ''
        },
        advertisedRoutes: [],
        detectedSubnets: [],
        availableExitNodes: [],
        activeExitNode: null,
        selectedExitNode: '',
        newRoute: '',
        logs: '',
        message: '',
        messageType: 'success',

        init() {
            this.loadStatus();
            this.loadSettings();
            this.loadDetectedSubnets();
        },

        async refreshStatus() {
            await this.loadStatus();
            this.showMessage('Status refreshed', 'success');
        },

        async loadStatus() {
            try {
                const response = await fetch('/api/status');
                if (response.ok) {
                    this.status = await response.json();
                    this.updateStatusInfo();
                }
            } catch (error) {
                console.error('Failed to load status:', error);
            }
        },

        async loadSettings() {
            try {
                const response = await fetch('/api/tailscale-settings');
                if (response.ok) {
                    const data = await response.json();
                    // Merge settings but preserve defaults if backend values are empty
                    this.settings = { 
                        ...this.settings, 
                        ...data,
                        hostname: data.hostname || 'tailsentry-router'
                    };
                    this.advertisedRoutes = data.advertise_routes || [];
                }
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        },

        async loadDetectedSubnets() {
            try {
                const response = await fetch('/api/local-subnets');
                if (response.ok) {
                    this.detectedSubnets = await response.json();
                }
            } catch (error) {
                console.error('Failed to load detected subnets:', error);
            }
        },

        updateStatusInfo() {
            if (this.status) {
                // Update active exit node
                this.activeExitNode = this.getActiveExitNode();
                
                // Update available exit nodes from peers
                this.availableExitNodes = this.getAvailableExitNodes();
            }
        },

        getActiveExitNode() {
            if (!this.status || !this.status.Peer) return null;
            
            for (const [id, peer] of Object.entries(this.status.Peer)) {
                if (peer.ExitNode) {
                    return peer.HostName || peer.DNSName || id;
                }
            }
            return null;
        },

        getAvailableExitNodes() {
            if (!this.status || !this.status.Peer) return [];
            
            const nodes = [];
            for (const [id, peer] of Object.entries(this.status.Peer)) {
                if (peer.ExitNodeOption) {
                    nodes.push({
                        id: id,
                        name: peer.HostName || peer.DNSName || id,
                        ip: peer.TailscaleIPs?.[0] || 'Unknown'
                    });
                }
            }
            return nodes;
        },

        async applyBasicSettings() {
            try {
                const response = await fetch('/api/tailscale-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        hostname: this.settings.hostname,
                        accept_routes: this.settings.accept_routes,
                        advertise_routes: this.advertisedRoutes,
                        tailscale_pat: this.settings.tailscale_pat
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    this.showMessage('Basic settings applied successfully', 'success');
                    this.loadStatus();
                } else {
                    this.showMessage('Error: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            }
        },

        async clearPAT() {
            if (confirm('Are you sure you want to clear the Personal Access Token? This will disable API functionality.')) {
                this.settings.tailscale_pat = '';
                await this.applyBasicSettings();
            }
        },

        async applyExitNodeSettings() {
            try {
                const response = await fetch('/api/tailscale-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        exit_node_enable: this.settings.exit_node_enable,
                        exit_node_firewall: this.settings.exit_node_firewall,
                        advertise_routes: this.advertisedRoutes
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    this.showMessage('Exit node settings applied successfully', 'success');
                    this.loadStatus();
                } else {
                    this.showMessage('Error: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            }
        },

        addRoute() {
            if (this.newRoute && !this.advertisedRoutes.includes(this.newRoute)) {
                this.advertisedRoutes.push(this.newRoute);
                this.newRoute = '';
                this.applyRouteChanges();
            }
        },

        addDetectedRoute(cidr) {
            if (!this.advertisedRoutes.includes(cidr)) {
                this.advertisedRoutes.push(cidr);
                this.applyRouteChanges();
            }
        },

        removeRoute(route) {
            this.advertisedRoutes = this.advertisedRoutes.filter(r => r !== route);
            this.applyRouteChanges();
        },

        async applyRouteChanges() {
            try {
                const response = await fetch('/api/subnet-routes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ routes: this.advertisedRoutes })
                });
                
                const result = await response.json();
                if (result.success) {
                    this.showMessage('Routes updated successfully', 'success');
                } else {
                    this.showMessage('Error updating routes: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            }
        },

        async setExitNode() {
            try {
                const response = await fetch('/api/exit-node', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        exit_node: this.selectedExitNode || null 
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    this.showMessage('Exit node updated successfully', 'success');
                    this.loadStatus();
                } else {
                    this.showMessage('Error setting exit node: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            }
        },

        async serviceAction(action) {
            try {
                const response = await fetch('/api/tailscale-service', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });
                
                const result = await response.json();
                if (result.success) {
                    this.showMessage(`Service ${action} completed successfully`, 'success');
                    if (action !== 'status') {
                        setTimeout(() => this.loadStatus(), 2000);
                    }
                } else {
                    this.showMessage('Error: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            }
        },

        async getLogs() {
            try {
                const response = await fetch('/api/tailscale-logs');
                if (response.ok) {
                    const result = await response.json();
                    this.logs = result.logs || 'No logs available';
                } else {
                    this.logs = 'Failed to retrieve logs';
                }
            } catch (error) {
                this.logs = 'Error retrieving logs: ' + error.message;
            }
        },

        async getNetworkMetrics() {
            try {
                const response = await fetch('/api/network-metrics');
                if (response.ok) {
                    const result = await response.json();
                    this.showMessage('Network metrics retrieved successfully', 'success');
                    console.log('Network metrics:', result);
                } else {
                    this.showMessage('Failed to retrieve network metrics', 'error');
                }
            } catch (error) {
                this.showMessage('Error retrieving metrics: ' + error.message, 'error');
            }
        },

        async clearCache() {
            try {
                const response = await fetch('/api/clear-cache', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    this.showMessage('Cache cleared successfully', 'success');
                    this.loadStatus();
                } else {
                    this.showMessage('Error clearing cache: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                this.showMessage('Network error: ' + error.message, 'error');
            }
        },

        showMessage(text, type = 'success') {
            this.message = text;
            this.messageType = type;
            setTimeout(() => {
                this.message = '';
            }, 5000);
        }
    }
}
</script>
{% endblock %}
