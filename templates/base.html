<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}TailSentry{% endblock %}</title>
  <link rel="stylesheet" href="/static/tailwind.min.css">
  <link rel="stylesheet" href="/static/dark-mode-addon.css">
  <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
  <style>
    [x-cloak] { display: none !important; }
  </style>
  <!-- Load dashboard definition BEFORE Alpine so window.dashboard exists when Alpine initializes -->
  <script src="/static/dashboard.js"></script>
  <script src="/static/alpine.min.js" defer></script>
  <script src="/static/alpine-focus.min.js" defer></script>
  <script>
    // Global theme initialization - runs before Alpine.js
    (function() {
      const theme = localStorage.getItem('theme') || 'system';
      const isDark = theme === 'dark' || 
                    (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
      
      if (isDark) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    })();
    
    // Expose CSRF token to inline forms if present in request.state
  window.__CSRF_TOKEN__ = "{{ request.state.csrf_token if request.state.csrf_token is defined else request.cookies.get('csrf_token', '') }}";
  </script>
  {% block head %}{% endblock %}
</head>
<body x-data="{ darkMode: document.documentElement.classList.contains('dark') }" :class="{ 'dark': darkMode }" class="min-h-screen bg-gray-50 dark:bg-gray-900">
  <!-- Main Navigation -->
  <nav class="flex items-center justify-between px-6 py-4 bg-indigo-700 dark:bg-gray-800 text-white shadow border-b border-indigo-800 dark:border-gray-700" role="navigation" aria-label="Main Navigation">
    <div class="flex items-center gap-3">
      <img src="/static/favicon.svg" class="h-8 w-8" alt="TailSentry logo">
      <span class="font-bold text-xl tracking-tight">TailSentry</span>
    </div>
    <div class="flex items-center gap-4">
      <a href="/dashboard" class="hover:bg-indigo-800 dark:hover:bg-gray-700 px-3 py-1 rounded transition {% if active_nav == 'dashboard' %}bg-indigo-900 dark:bg-gray-600 font-semibold{% endif %}" aria-label="Dashboard" title="Dashboard">Dashboard</a>
  {% if user and user.role == 'admin' %}
  <a href="/settings/tailsentry" class="hover:bg-indigo-800 dark:hover:bg-gray-700 px-3 py-1 rounded transition {% if active_nav in ['settings', 'tailsentry_settings', 'security_settings', 'tailscale_settings', 'manage_users', 'sso_settings', 'appearance', 'notifications'] %}bg-indigo-900 dark:bg-gray-600 font-semibold{% endif %}" aria-label="Settings" title="Settings">Settings</a>
  {% endif %}
      <a href="/profile" class="hover:bg-indigo-800 dark:hover:bg-gray-700 px-3 py-1 rounded transition flex items-center {% if active_nav == 'profile' %}bg-indigo-900 dark:bg-gray-600 font-semibold{% endif %}" aria-label="Profile" title="Profile">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 15c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
        Profile
      </a>
      <a href="/logout" class="bg-red-500 hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-700 px-3 py-1 rounded transition-colors" aria-label="Logout" title="Logout">Logout</a>
    </div>
  </nav>
  
  <!-- Settings Subnavigation (shown only on settings and related pages) -->
  {% if show_settings_nav is defined and show_settings_nav %}
  <nav class="bg-gray-50 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700" aria-label="Settings Subnavigation">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex flex-wrap gap-2 sm:gap-4">
        
        <a href="/settings/security" 
           class="px-4 py-2 rounded-lg font-medium transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 {% if active_nav == 'security_settings' %}bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg{% else %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white{% endif %}" 
           {% if active_nav == 'security_settings' %}aria-current="page"{% endif %}>
          Security
        </a>
        <a href="/settings/tailsentry" 
           class="px-4 py-2 rounded-lg font-medium transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 {% if active_nav == 'tailsentry_settings' %}bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg{% else %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white{% endif %}" 
           {% if active_nav == 'tailsentry_settings' %}aria-current="page"{% endif %}>
          Config Management
        </a>
        <a href="/settings/tailscale" 
           class="px-4 py-2 rounded-lg font-medium transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 {% if active_nav == 'tailscale_settings' %}bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg{% else %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white{% endif %}" 
           {% if active_nav == 'tailscale_settings' %}aria-current="page"{% endif %}>
          Tailscale Settings
        </a>
        <a href="/settings/users" 
           class="px-4 py-2 rounded-lg font-medium transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 {% if active_nav == 'manage_users' %}bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg{% else %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white{% endif %}" 
           {% if active_nav == 'manage_users' %}aria-current="page"{% endif %}>
          Manage Users
        </a>
        <a href="/settings/sso" 
           class="px-4 py-2 rounded-lg font-medium transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 {% if active_nav == 'sso_settings' %}bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg{% else %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white{% endif %}" 
           {% if active_nav == 'sso_settings' %}aria-current="page"{% endif %}>
          SSO Settings
        </a>
        <a href="/settings/appearance" 
           class="px-4 py-2 rounded-lg font-medium transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 {% if active_nav == 'appearance' %}bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg{% else %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white{% endif %}" 
           {% if active_nav == 'appearance' %}aria-current="page"{% endif %}>
          Appearance
        </a>
        <a href="/settings/notifications" 
           class="px-4 py-2 rounded-lg font-medium transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 {% if active_nav == 'notifications' %}bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg{% else %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-indigo-900 dark:hover:bg-indigo-800 dark:hover:text-white{% endif %}" 
           {% if active_nav == 'notifications' %}aria-current="page"{% endif %}>
          Notifications
        </a>
        <a href="/logs" 
           class="px-4 py-2 rounded-lg font-medium transition-all focus:outline-none focus:ring-2 focus:ring-indigo-500 {% if active_nav == 'logs' %}bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg{% else %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-100 hover:bg-indigo-200 hover:text-gray-900 dark:hover:bg-gray-800 dark:hover:text-white{% endif %}" 
           {% if active_nav == 'logs' %}aria-current="page"{% endif %}>
          Logs
        </a>
      </div>
    </div>
  </nav>
  {% endif %}
  
  <main>
    {% block content %}{% endblock %}
  </main>
  {% block scripts %}{% endblock %}
</body>
</html>
