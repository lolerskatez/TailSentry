{% extends "base.html" %}
{% block title %}TailSentry - Dashboard{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto py-8 px-4 grid grid-cols-1 md:grid-cols-3 gap-6">
  <!-- Device Overview -->
  <section class="col-span-1 bg-white shadow rounded-lg p-6 mb-4 dark:bg-gray-800 dark:text-gray-100" aria-labelledby="device-overview-title">
    <div id="device-overview-title" class="text-lg font-semibold mb-2">Device Overview</div>
    <div class="mb-2"><span class="font-semibold">Hostname:</span> <span x-text="device.hostname"></span></div>
    <div class="mb-2"><span class="font-semibold">Tailscale IP:</span> <span x-text="device.ip"></span></div>
    <div class="mb-2"><span class="font-semibold">Status:</span> <span :class="device.online ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'" x-text="device.online ? 'Online' : 'Offline'"></span></div>
      <div class="mb-2"><span class="font-semibold">Role:</span> <span x-text="device.role"></span></div>
      <div class="mb-2"><span class="font-semibold">Uptime:</span> <span x-text="device.uptime"></span></div>
      <div class="mb-2"><span class="font-semibold">Exit Node:</span> <span x-text="device.isExit ? 'Yes' : 'No'"></span></div>
      <div class="mb-2"><span class="font-semibold">Subnet Routes:</span> <span x-text="subnets.length"></span></div>
      <button @click="refresh()" class="mt-2 px-3 py-1 bg-indigo-500 text-white rounded hover:bg-indigo-600 dark:bg-indigo-600 dark:hover:bg-indigo-700 transition-colors">Refresh</button>
    </section>

    <!-- Peers List -->
    <section class="col-span-2 bg-white shadow rounded-lg p-6 mb-4 dark:bg-gray-800 dark:text-gray-100" aria-labelledby="connected-devices-title">
      <div id="connected-devices-title" class="text-lg font-semibold mb-2 flex items-center justify-between">
        <span>Connected Devices</span>
        <input type="text" x-model="peerFilter" placeholder="Search..." class="px-2 py-1 rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="bg-gray-100 dark:bg-gray-700">
              <th class="px-2 py-1">Hostname</th>
              <th class="px-2 py-1">IP</th>
              <th class="px-2 py-1">OS</th>
              <th class="px-2 py-1">Last Seen</th>
              <th class="px-2 py-1">Tags</th>
              <th class="px-2 py-1">Status</th>
              <th class="px-2 py-1">Actions</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="peer in filteredPeers()" :key="peer.id">
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-800">
                <td class="px-2 py-1 font-medium" x-text="peer.hostname"></td>
                <td class="px-2 py-1" x-text="peer.ip"></td>
                <td class="px-2 py-1" x-text="peer.os"></td>
                <td class="px-2 py-1" x-text="peer.lastSeen"></td>
                <td class="px-2 py-1" x-text="peer.tags.join(', ')"></td>
                <td class="px-2 py-1">
                  <span :class="peer.online ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'" x-text="peer.online ? 'Online' : 'Offline'"></span>
                </td>
                <td class="px-2 py-1">
                  <button @click="pingPeer(peer)" class="text-xs bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-200 px-2 py-1 rounded hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">Ping</button>
                  <button @click="openPeerModal(peer)" class="text-xs bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200 px-2 py-1 rounded hover:bg-gray-300 dark:hover:bg-gray-500 ml-1 transition-colors">Details</button>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Network Traffic & Stats -->
    <section class="col-span-3 bg-white shadow rounded-lg p-6 mb-4 dark:bg-gray-800 dark:text-gray-100" aria-labelledby="network-traffic-title">
      <div id="network-traffic-title" class="text-lg font-semibold mb-2">Network Traffic</div>
      <div class="flex gap-8 mb-2">
        <div><span class="font-semibold">Upload:</span> <span x-text="net.tx"></span></div>
        <div><span class="font-semibold">Download:</span> <span x-text="net.rx"></span></div>
        <div><span class="font-semibold">Active Peers:</span> <span x-text="peers.length"></span></div>
        <div><span class="font-semibold">Last Updated:</span> <span x-text="lastUpdated"></span></div>
      </div>
      <div class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded overflow-hidden">
        <div class="h-2 bg-indigo-500" :style="'width:' + net.activity + '%'" x-text="''"></div>
      </div>
    </section>

    <!-- Quick Actions & Features -->
    <section class="col-span-3 bg-white shadow rounded-lg p-6 mb-4 dark:bg-gray-800 dark:text-gray-100" aria-labelledby="quick-actions-title">
      <div id="quick-actions-title" class="text-lg font-semibold mb-2">Quick Actions</div>
      <div class="flex flex-wrap gap-4">
        <button @click="toggleExitNode()" class="bg-yellow-500 hover:bg-yellow-600 dark:bg-yellow-600 dark:hover:bg-yellow-700 text-white px-4 py-2 rounded transition-colors">Toggle Exit Node</button>
        <button @click="openSubnetModal()" class="bg-green-500 hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-700 text-white px-4 py-2 rounded transition-colors">Manage Subnets</button>
        <button @click="openKeyModal()" class="bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 text-white px-4 py-2 rounded transition-colors">Manage Keys</button>
        <button @click="openLogsModal()" class="bg-gray-500 hover:bg-gray-600 dark:bg-gray-600 dark:hover:bg-gray-700 text-white px-4 py-2 rounded transition-colors">View Logs</button>
      </div>
    </section>
  </main>

  <!-- Settings Modal -->
  <div x-show="openSettings" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="settings-title">
    <div x-data="{ authKey: '', isExitNode: false }" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-md">
      <div id="settings-title" class="text-lg font-semibold mb-4">Settings</div>
      <!-- Appearance Section -->
      <div class="mb-6">
        <div class="font-semibold mb-2 text-indigo-700 dark:text-indigo-400">Appearance</div>
        <div class="flex items-center justify-between mb-2">
          <span>Dark Mode</span>
          <input type="checkbox" x-model="darkMode" class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500 dark:focus:ring-indigo-400" @change="saveDarkMode()" aria-label="Toggle dark mode">
        </div>
        <div class="mb-2">
          <label class="block mb-1 font-medium" for="refresh-interval">Refresh Interval (seconds)</label>
          <input id="refresh-interval" type="number" x-model.number="refreshInterval" min="5" max="120" class="w-full px-2 py-1 rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
        </div>
      </div>

      <!-- TailScale Controller Section -->
      <div class="mb-6">
        <div class="font-semibold mb-2 text-indigo-700 dark:text-indigo-400">TailScale Controller</div>
        <!-- Auth Key Management -->
        <div class="mb-4">
          <label class="block mb-1 font-medium" for="auth-key">Authentication Key</label>
          <div class="flex gap-2">
            <input id="auth-key" type="text" x-model="authKey" class="w-full px-2 py-1 rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter or view current key">
            <button @click="regenerateAuthKey()" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 transition-colors" title="Regenerate Key">Regenerate</button>
          </div>
        </div>
        <!-- Exit Node Toggle -->
        <div class="mb-4 flex items-center justify-between">
          <span>Exit Node</span>
          <button @click="toggleExitNode()" :class="isExitNode ? 'bg-yellow-500 hover:bg-yellow-600 dark:bg-yellow-600 dark:hover:bg-yellow-700' : 'bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600'" class="px-3 py-1 text-white rounded transition-colors" x-text="isExitNode ? 'Enabled' : 'Disabled'"></button>
        </div>
        <!-- Subnet Routing -->
        <div class="mb-4">
          <div class="flex items-center justify-between mb-1">
            <span>Subnet Routing</span>
            <button @click="openSubnetModal()" class="px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600" title="Manage Subnets">Manage</button>
          </div>
          <div class="text-xs text-gray-500 dark:text-gray-400">Advertise or remove subnets for this node.</div>
        </div>
        <!-- Key Management -->
        <div class="mb-4">
          <div class="flex items-center justify-between mb-1">
            <span>Key Management</span>
            <button @click="openKeyModal()" class="px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600" title="Manage Keys">Manage</button>
          </div>
          <div class="text-xs text-gray-500 dark:text-gray-400">View, create, or revoke device keys.</div>
        </div>
      </div>

      <!-- Logs & Diagnostics Section -->
      <div class="mb-6">
        <div class="font-semibold mb-2 text-indigo-700">Logs & Diagnostics</div>
        <button @click="openLogsModal()" class="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 mb-2">View Logs</button>
        <div class="text-xs text-gray-500 dark:text-gray-400">Access logs and diagnostic information for troubleshooting.</div>
      </div>

      <div class="flex justify-end gap-2">
        <button @click="openSettings = false" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors">Close</button>
      </div>
    </div>
  </div>

  <!-- Peer Details Modal -->
  <div x-show="peerModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="peer-details-title">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-lg">
      <div id="peer-details-title" class="text-lg font-semibold mb-4">Peer Details</div>
      <div class="bg-gray-100 dark:bg-gray-900 p-4 rounded mb-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <div class="font-semibold">ID:</div>
            <div class="mb-2 text-sm text-gray-700 dark:text-gray-300" x-text="selectedPeer.id"></div>
          </div>
          <div>
            <div class="font-semibold">Hostname:</div>
            <div class="mb-2 text-sm text-gray-700 dark:text-gray-300" x-text="selectedPeer.hostname"></div>
          </div>
          <div>
            <div class="font-semibold">IP Address:</div>
            <div class="mb-2 text-sm text-gray-700 dark:text-gray-300" x-text="selectedPeer.ip"></div>
          </div>
          <div>
            <div class="font-semibold">Operating System:</div>
            <div class="mb-2 text-sm text-gray-700 dark:text-gray-300" x-text="selectedPeer.os"></div>
          </div>
          <div>
            <div class="font-semibold">Last Seen:</div>
            <div class="mb-2 text-sm text-gray-700 dark:text-gray-300" x-text="selectedPeer.lastSeen"></div>
          </div>
          <div>
            <div class="font-semibold">Tags:</div>
            <div class="mb-2 text-sm text-gray-700 dark:text-gray-300" x-text="Array.isArray(selectedPeer.tags) && selectedPeer.tags.length ? selectedPeer.tags.join(', ') : 'None'"></div>
          </div>
          <div>
            <div class="font-semibold">Status:</div>
            <div class="mb-2 text-sm" :class="selectedPeer.online ? 'text-green-600' : 'text-red-600'" x-text="selectedPeer.online ? 'Online' : 'Offline'"></div>
          </div>
        </div>
      </div>
      <div class="flex justify-end mt-4">
        <button @click="peerModal = false" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 rounded">Close</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div x-show="toast" class="fixed bottom-6 right-6 bg-indigo-600 text-white px-4 py-2 rounded shadow-lg z-50" x-text="toast" style="display: none;" role="status" aria-live="polite"></div>

<!-- Alpine data and methods are now provided by alt_dashboard.js -->
{% endblock %}
